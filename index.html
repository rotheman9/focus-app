<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus ‚Äî AI Productivity Intelligence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            min-height: 100vh;
            color: #ffffff;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }
        
        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #999;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .time {
            font-size: 48px;
            font-weight: 300;
            background: linear-gradient(180deg, #ffffff, #999999);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .date {
            font-size: 16px;
            color: #666;
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            font-size: 14px;
            color: #999;
        }

        /* Focus Section */
        .focus-section {
            margin-bottom: 40px;
        }

        .section-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 15px;
        }

        .focus-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
            font-size: 24px;
            color: white;
            outline: none;
            margin-bottom: 30px;
        }

        .focus-timer {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .timer-display {
            font-size: 20px;
            color: #999;
            min-width: 60px;
        }

        .btn {
            padding: 10px 20px;
            background: white;
            color: black;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Goals */
        .goal-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            outline: none;
            margin-bottom: 20px;
        }

        .goal-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .goal-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }
        
        .goal-item.has-subtasks {
            border-left: 3px solid #667eea;
        }

        .goal-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            margin-right: 15px;
        }

        .goal-item.completed {
            opacity: 0.5;
        }

        .goal-item.completed .goal-checkbox {
            background: white;
        }

        .goal-text {
            flex: 1;
        }

        .goal-item.completed .goal-text {
            text-decoration: line-through;
        }

        .goal-points {
            color: #fbbf24;
            font-size: 13px;
            margin-right: 10px;
        }
        
        .goal-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .ai-breakdown-btn {
            padding: 4px 10px;
            background: linear-gradient(135deg, #667eea, #a78bfa);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .ai-breakdown-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
        }

        /* Subtasks */
        .subtasks-container {
            margin-left: 35px;
            margin-top: 10px;
            padding-left: 15px;
            border-left: 2px solid rgba(102, 126, 234, 0.3);
        }
        
        .subtask-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .subtask-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .subtask-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .subtask-item.completed .subtask-checkbox {
            background: #667eea;
        }
        
        .subtask-item.completed {
            opacity: 0.6;
        }
        
        .subtask-text {
            flex: 1;
        }
        
        .subtask-item.completed .subtask-text {
            text-decoration: line-through;
        }
        
        .subtask-points {
            color: #a78bfa;
            font-size: 11px;
        }
        
        .expand-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
            color: #667eea;
            margin-right: 5px;
        }
        
        .expand-toggle.expanded {
            transform: rotate(90deg);
        }

        /* Progress */
        .progress-section {
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .progress-item {
            margin-bottom: 15px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #a78bfa);
            transition: width 0.5s;
        }

        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            margin-top: 5px;
        }

        /* Modals */
        .context-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        
        .context-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .context-modal-content {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.98), rgba(30, 30, 30, 0.98));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .context-input, .context-textarea, .context-select {
            width: 100%;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            outline: none;
            transition: all 0.2s;
            margin-bottom: 15px;
        }

        /* Loading */
        .ai-thinking {
            display: inline-block;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(167, 139, 250, 0.2));
            border-radius: 12px;
            font-size: 13px;
            color: #a78bfa;
            margin: 10px 0;
            animation: pulse 1.5s infinite;
            width: 100%;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; script-src 'self' 'unsafe-inline'; connect-src 'self' https://api.openai.com https://api.anthropic.com https://serpapi.com https://*.wikipedia.org;">
    
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="App.switchTab('home', this)">üè† Home</button>
            <button class="nav-tab" onclick="App.switchTab('analytics', this)">üìä Analytics</button>
        </div>
        
        <!-- Home Tab -->
        <div id="home-tab" class="tab-content active">
            <div class="header">
                <div class="time" id="time">--:--</div>
                <div class="date" id="date">Loading...</div>
                <div class="stats-row">
                    <div class="stat-badge">
                        <span>üî•</span>
                        <span id="streak">1 day streak</span>
                    </div>
                    <div class="stat-badge">
                        <span>üíé</span>
                        <span id="level">Level 1</span>
                    </div>
                    <div class="stat-badge">
                        <span>‚≠ê</span>
                        <span id="points">0 points</span>
                    </div>
                </div>
            </div>

            <div class="focus-section">
                <div class="section-label">Today's Focus</div>
                <input type="text" class="focus-input" id="focusInput" 
                       placeholder="What's your ONE thing today?" 
                       onkeypress="Goals.handleFocusEnter(event)">
                <div class="focus-timer">
                    <div class="timer-display" id="timer">25:00</div>
                    <button class="btn" id="timerBtn" onclick="Timer.toggle()">Start Focus</button>
                    <button class="btn secondary" onclick="Timer.reset()">Reset</button>
                </div>
            </div>

            <div class="goals-section">
                <div class="section-label">Additional Goals</div>
                <input type="text" class="goal-input" id="goalInput" 
                       placeholder="Add a goal..." 
                       onkeypress="Goals.handleGoalEnter(event)">
                <div id="goalsList"></div>
            </div>

            <div class="progress-section">
                <div class="progress-item">
                    <div class="progress-header">
                        <span>Daily Progress</span>
                        <span id="dailyProgress">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="dailyBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="progress-item">
                    <div class="progress-header">
                        <span>Level Progress</span>
                        <span id="levelProgress">0/100 XP</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="levelBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <div class="analytics-grid" id="statsGrid"></div>
        </div>
    </div>
    
    <!-- Context Modal -->
    <div id="contextModal" class="context-modal">
        <div class="context-modal-content">
            <h3 style="color: #a78bfa; margin-bottom: 20px;">üß† AI Context Analysis</h3>
            <div id="contextTaskDisplay" style="padding: 10px; background: rgba(102, 126, 234, 0.1); 
                        border-radius: 8px; margin-bottom: 20px;"></div>
            <div id="contextQuestions"></div>
            <div id="contextStatus"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="AI.generateBreakdown()" 
                        style="flex: 1; background: linear-gradient(135deg, #667eea, #a78bfa); color: white;">
                    üöÄ Generate Smart Breakdown
                </button>
                <button class="btn secondary" onclick="AI.closeModal()" style="flex: 1;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // State Management
        const State = {
            data: {
                points: 0,
                level: 1,
                xp: 0,
                xpNeeded: 100,
                streak: 1,
                goals: [],
                stats: {
                    daily: {},
                    hourly: new Array(24).fill(0)
                }
            },
            
            load() {
                try {
                    const saved = localStorage.getItem('focusApp');
                    if (saved) {
                        this.data = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            },
            
            save() {
                try {
                    localStorage.setItem('focusApp', JSON.stringify(this.data));
                } catch (e) {
                    console.error('Error saving data:', e);
                }
            }
        };

        // UI Helpers
        const UI = {
            updateClock() {
                const now = new Date();
                const hh = now.getHours().toString().padStart(2, '0');
                const mm = now.getMinutes().toString().padStart(2, '0');
                document.getElementById('time').textContent = `${hh}:${mm}`;
                document.getElementById('date').textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            },
            
            updateDisplay() {
                document.getElementById('points').textContent = `${State.data.points} points`;
                document.getElementById('level').textContent = `Level ${State.data.level}`;
                document.getElementById('streak').textContent = `${State.data.streak} day streak`;
                document.getElementById('levelProgress').textContent = `${State.data.xp}/${State.data.xpNeeded} XP`;
                const pct = Math.min(100, Math.round((State.data.xp / Math.max(1, State.data.xpNeeded)) * 100));
                document.getElementById('levelBar').style.width = pct + '%';
            },
            
            updateProgress() {
                const total = State.data.goals.length;
                const completed = State.data.goals.filter(g => g.completed).length;
                const pct = total === 0 ? 0 : Math.round((completed / total) * 100);
                document.getElementById('dailyProgress').textContent = pct + '%';
                document.getElementById('dailyBar').style.width = pct + '%';
            },
            
            renderAnalytics() {
                const grid = document.getElementById('statsGrid');
                const today = new Date().toDateString();
                const d = State.data.stats.daily[today] || { tasks: 0, points: 0, focus: 0 };
                const totalGoals = State.data.goals.length;
                const completedGoals = State.data.goals.filter(g => g.completed).length;
                grid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${d.tasks}</div>
                        <div class="stat-label">Tasks Completed Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${d.focus}m</div>
                        <div class="stat-label">Focus Minutes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${State.data.points}</div>
                        <div class="stat-label">Total Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${completedGoals}/${totalGoals}</div>
                        <div class="stat-label">Goals Completed</div>
                    </div>
                `;
            }
        };

        // Timer Module
        const Timer = {
            interval: null,
            timeLeft: 25 * 60,
            
            toggle() {
                const btn = document.getElementById('timerBtn');
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                    btn.textContent = 'Resume';
                } else {
                    this.interval = setInterval(() => {
                        if (this.timeLeft > 0) {
                            this.timeLeft--;
                            this.updateDisplay();
                        } else {
                            this.complete();
                        }
                    }, 1000);
                    btn.textContent = 'Pause';
                }
            },
            
            reset() {
                clearInterval(this.interval);
                this.interval = null;
                this.timeLeft = 25 * 60;
                this.updateDisplay();
                document.getElementById('timerBtn').textContent = 'Start Focus';
            },
            
            updateDisplay() {
                const mins = Math.floor(this.timeLeft / 60);
                const secs = this.timeLeft % 60;
                document.getElementById('timer').textContent = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            },
            
            complete() {
                this.reset();
                Points.add(100);
                Stats.update('focus', 25);
                alert('Great focus session! +100 points');
            }
        };

        // Points Module
        const Points = {
            add(points) {
                State.data.points += points;
                State.data.xp += points;
                
                while (State.data.xp >= State.data.xpNeeded) {
                    State.data.level++;
                    State.data.xp -= State.data.xpNeeded;
                    State.data.xpNeeded = Math.floor(State.data.xpNeeded * 1.2);
                }
                
                UI.updateDisplay();
                State.save();
            }
        };

        // Stats Module
        const Stats = {
            update(type, value) {
                const today = new Date().toDateString();
                if (!State.data.stats.daily[today]) {
                    State.data.stats.daily[today] = { tasks: 0, points: 0, focus: 0 };
                }
                
                if (type === 'tasks') {
                    State.data.stats.daily[today].tasks += value;
                    State.data.stats.daily[today].points += 50;
                } else if (type === 'focus') {
                    State.data.stats.daily[today].focus += value;
                }
                
                State.save();
            }
        };

        // Goals Module
        const Goals = {
            handleFocusEnter(e) {
                if (e.key === 'Enter' && e.target.value) {
                    const goal = this.add(e.target.value, 150, true);
                    e.target.value = '';
                    // Auto-open AI breakdown for ONE thing
                    setTimeout(() => AI.breakdown(goal.id), 50);
                }
            },
            
            handleGoalEnter(e) {
                if (e.key === 'Enter' && e.target.value) {
                    this.add(e.target.value, 50, false);
                    e.target.value = '';
                }
            },
            
            add(text, points, isMain) {
                const goal = {
                    id: Date.now(),
                    text,
                    points,
                    completed: false,
                    isMain,
                    subtasks: [],
                    expanded: true
                };
                State.data.goals.push(goal);
                this.render();
                State.save();
                return goal;
            },
            
            render() {
                const list = document.getElementById('goalsList');
                if (!list) return;
                
                list.innerHTML = State.data.goals.map(goal => {
                    const hasSubtasks = goal.subtasks && goal.subtasks.length > 0;
                    let html = `
                        <div class="goal-item ${goal.completed ? 'completed' : ''} ${hasSubtasks ? 'has-subtasks' : ''}">
                            ${hasSubtasks ? `<div class="expand-toggle ${goal.expanded ? 'expanded' : ''}" 
                                onclick="Goals.toggleExpand(${goal.id})">‚ñ∂</div>` : ''}
                            <div class="goal-checkbox" onclick="Goals.toggle(${goal.id})"></div>
                            <div class="goal-text">${goal.text}</div>
                            <div class="goal-actions">
                                <div class="goal-points">+${goal.points} pts</div>
                                ${!goal.completed && !hasSubtasks ? 
                                    `<button class="ai-breakdown-btn" onclick="AI.breakdown(${goal.id})">
                                        ü§ñ AI Break
                                    </button>` : ''}
                            </div>
                        </div>
                    `;
                    
                    if (hasSubtasks && goal.expanded) {
                        html += '<div class="subtasks-container">';
                        html += goal.subtasks.map(st => `
                            <div class="subtask-item ${st.completed ? 'completed' : ''}" 
                                 onclick="Goals.toggleSubtask(${goal.id}, ${st.id})">
                                <div class="subtask-checkbox"></div>
                                <div class="subtask-text">${st.text}</div>
                                <div class="subtask-points">+${st.points} pts</div>
                            </div>
                        `).join('');
                        html += '</div>';
                    }
                    
                    return html;
                }).join('');
                
                UI.updateProgress();
            },
            
            toggle(id) {
                const goal = State.data.goals.find(g => g.id === id);
                if (goal && !goal.completed) {
                    goal.completed = true;
                    Points.add(goal.points);
                    Stats.update('tasks', 1);
                    this.render();
                    State.save();
                }
            },
            
            toggleSubtask(goalId, subtaskId) {
                const goal = State.data.goals.find(g => g.id === goalId);
                if (goal) {
                    const subtask = goal.subtasks.find(st => st.id === subtaskId);
                    if (subtask && !subtask.completed) {
                        subtask.completed = true;
                        Points.add(subtask.points);
                        Stats.update('tasks', 1);
                        this.render();
                        State.save();
                    }
                }
            },
            
            toggleExpand(goalId) {
                const goal = State.data.goals.find(g => g.id === goalId);
                if (goal) {
                    goal.expanded = !goal.expanded;
                    this.render();
                }
            }
        };

        // AI Module
        const AI = {
            currentGoal: null,
            
            breakdown(goalId) {
                const goal = State.data.goals.find(g => g.id === goalId);
                if (!goal) return;
                
                this.currentGoal = goal;
                this.openModal(goal);
            },
            
            openModal(goal) {
                const modal = document.getElementById('contextModal');
                modal.classList.add('active');
                
                document.getElementById('contextTaskDisplay').innerHTML = 
                    `<strong>Task:</strong> ${goal.text}`;
                
                document.getElementById('contextQuestions').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #a78bfa;">
                            ‚è∞ When is the deadline?
                        </label>
                        <input type="text" class="context-input" id="deadline" 
                               placeholder="e.g., tomorrow, next week">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #a78bfa;">
                            üí™ Energy Level
                        </label>
                        <select class="context-select" id="energy">
                            <option>High - Ready for anything</option>
                            <option>Medium - Normal focus</option>
                            <option>Low - Need easy tasks</option>
                        </select>
                    </div>
                `;
                document.getElementById('contextStatus').innerHTML = '';
            },
            
            closeModal() {
                document.getElementById('contextModal').classList.remove('active');
                this.currentGoal = null;
            },
            
            async generateBreakdown() {
                if (!this.currentGoal) return;
                
                const deadline = document.getElementById('deadline').value || 'this week';
                const energy = document.getElementById('energy').value || 'Medium';
                const goal = this.currentGoal;
                const status = document.getElementById('contextStatus');
                
                // Show AI thinking
                status.innerHTML = `<div class="ai-thinking">Thinking with AI and best practices‚Ä¶</div>`;
                
                // Try serverless research first
                let subtasks = [];
                try {
                    const resp = await fetch('/api/research-breakdown', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task: goal.text })
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        const plan = Array.isArray(data.breakdown) ? data.breakdown : [];
                        // Convert to subtasks with points split by estimated time
                        const totalTime = Math.max(1, plan.reduce((s, t) => s + (t.estimatedTime || 30), 0));
                        subtasks = plan.map((t, idx) => ({
                            id: Date.now() + idx,
                            text: t.text,
                            completed: false,
                            points: Math.max(5, Math.round(goal.points * (t.estimatedTime || 30) / totalTime))
                        }));
                    }
                } catch (_) {
                    // ignore and fallback
                }
                
                // Fallback to local heuristic if needed
                if (subtasks.length === 0) {
                    subtasks = this.createSubtasks(goal.text, goal.points, deadline, energy);
                }
                
                // Apply
                goal.subtasks = subtasks;
                goal.expanded = true;
                this.closeModal();
                Goals.render();
                State.save();
            },
            
            createSubtasks(taskText, totalPoints, deadline, energy) {
                const t = taskText.toLowerCase();
                const parts = [];
                const add = (text, weight) => parts.push({ text, weight });
                
                if (t.includes('website')) {
                    add('üìã Define goals, audience, and sitemap', 2);
                    add('üé® Create UI wireframes or pick a template', 2);
                    add('üíª Set up repo and project (framework/build)', 2);
                    add('üß© Build core pages (Home/About/Contact)', 3);
                    add('‚öôÔ∏è Add navigation, responsive layout', 2);
                    add('‚ôø Accessibility pass (WCAG basics)', 1);
                    add('‚ö° Performance & SEO basics (meta, titles)', 1);
                    add('üß™ Test on devices/browsers', 1);
                    add('üöÄ Deploy & set up analytics', 2);
                } else if (t.includes('presentation')) {
                    add('üìä Research and gather content', 2);
                    add('üß≠ Outline story arc', 1);
                    add('üé® Design slide master', 2);
                    add('‚úçÔ∏è Draft slides content', 3);
                    add('üîç Refine visuals and charts', 2);
                    add('üó£Ô∏è Rehearse and time it', 1);
                } else if (t.includes('marketing')) {
                    add('üîé Audience and competitor research', 2);
                    add('üéØ Define objectives and KPIs', 1);
                    add('üó∫Ô∏è Channel plan (email, social, paid)', 2);
                    add('üìù Content calendar', 2);
                    add('‚öôÔ∏è Set up tracking & analytics', 1);
                    add('üß™ Launch small test and iterate', 1);
                } else {
                    // Generic plan
                    add('üîç Clarify outcome and constraints', 1);
                    add('üó∫Ô∏è Break into 3‚Äì5 major steps', 1);
                    add('üìÖ Estimate and schedule blocks', 1);
                    add('üíª Execute first step', 2);
                    add('üß™ Review and adjust plan', 1);
                    add('üöÄ Deliver or share progress', 1);
                }
                const totalWeight = parts.reduce((s, p) => s + p.weight, 0);
                return parts.map((p, i) => ({
                    id: Date.now() + i,
                    text: p.text,
                    completed: false,
                    points: Math.max(5, Math.round(totalPoints * (p.weight / totalWeight)))
                }));
            }
        };

        // App Module
        const App = {
            switchTab(tab, el) {
                document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                const id = tab === 'home' ? 'home-tab' : 'analytics-tab';
                document.getElementById(id).classList.add('active');
                if (tab === 'analytics') UI.renderAnalytics();
            },
            init() {
                State.load();
                UI.updateClock();
                setInterval(UI.updateClock, 15 * 1000);
                UI.updateDisplay();
                UI.updateProgress();
                Timer.updateDisplay();
                Goals.render();
            }
        };

        // Boot
        App.init();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus ‚Äî AI Productivity Intelligence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #000000;
            min-height: 100vh;
            color: #ffffff;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 20px;
            animation: fadeIn 1s ease;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 60px;
            align-items: start;
        }

        /* Navigation Bar */
        .nav-bar {
            grid-column: 1 / -1;
            margin-bottom: 30px;
            padding: 0 0 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-items {
            display: flex;
            gap: 20px;
        }

        .nav-item {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
            transform: translateY(-1px);
        }

        .nav-item.active {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.3);
            color: #a5b4fc;
        }

        /* Page System */
        .page {
            grid-column: 1 / 2;
            min-height: 500px;
        }

        .page.hidden {
            display: none;
        }

        .main-content {
            max-width: 680px;
            padding: 60px 0;
            text-align: center;
        }

        .main-content .header {
            margin-bottom: 120px;
        }

        .main-content .time {
            font-size: 72px;
            font-weight: 300;
            letter-spacing: -3px;
            margin-bottom: 20px;
            background: linear-gradient(180deg, #ffffff 0%, #cccccc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }

        .main-content .date {
            font-size: 20px;
            color: #999;
            font-weight: 400;
            letter-spacing: 1px;
        }

        .main-content .focus-section {
            margin-bottom: 80px;
        }

        .main-content .section-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #999;
            margin-bottom: 32px;
            font-weight: 600;
        }

        .main-content .focus-input-container {
            margin-bottom: 60px;
        }

        .main-content .focus-input {
            font-size: 36px;
            font-weight: 300;
            padding: 32px 0;
            border: none;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            background: transparent;
            color: white;
            text-align: center;
            width: 100%;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .main-content .focus-input:focus {
            border-bottom-color: rgba(255, 255, 255, 0.3);
        }

        .main-content .focus-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .main-content .focus-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

        .main-content .timer-display {
            font-size: 28px;
            font-weight: 400;
            color: #ccc;
            font-variant-numeric: tabular-nums;
            min-width: 80px;
        }

        .main-content .timer-btn {
            padding: 16px 32px;
            background: #ffffff;
            color: #000000;
            border: none;
            border-radius: 100px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
        }

        .main-content .timer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
        }

        .main-content .reset-btn {
            padding: 16px 32px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 100px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
        }

        .main-content .reset-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-1px);
        }



        .analytics-sidebar {
            position: sticky;
            top: 60px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            padding: 24px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .analytics-sidebar .ai-status {
            margin-bottom: 24px;
        }

        .analytics-sidebar .stats-row {
            margin-bottom: 32px;
            gap: 12px;
        }

        .analytics-sidebar .ai-brain {
            margin-bottom: 32px;
            height: 100px;
        }

        .analytics-sidebar .predictions-bar {
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .analytics-sidebar .ai-section {
            margin-bottom: 32px;
        }

        .analytics-sidebar .powerups {
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .analytics-sidebar .progress-section {
            margin-bottom: 32px;
            background: transparent;
            border: none;
            padding: 0;
        }

        .analytics-sidebar .section-label {
            margin-bottom: 16px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #666;
            font-weight: 600;
        }

        .analytics-sidebar .progress-item {
            margin-bottom: 16px;
        }

        .analytics-sidebar .progress-item:last-child {
            margin-bottom: 0;
        }

        .activity-log {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 13px;
            color: #ccc;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .activity-icon.focus {
            background: rgba(102, 126, 234, 0.2);
            color: #a5b4fc;
        }

        .activity-icon.goal {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .activity-icon.level {
            background: rgba(167, 139, 250, 0.2);
            color: #a78bfa;
        }

        .activity-text {
            flex: 1;
            line-height: 1.4;
        }

        .activity-time {
            font-size: 11px;
            color: #666;
            white-space: nowrap;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Header */
        .header {
            margin-bottom: 60px;
            text-align: center;
            position: relative;
        }

        .ai-status {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 20px;
            font-size: 11px;
            color: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .time {
            font-size: 48px;
            font-weight: 500;
            letter-spacing: -1px;
            margin-bottom: 8px;
            background: linear-gradient(180deg, #ffffff 0%, #999999 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .date {
            font-size: 16px;
            color: #666;
            font-weight: 400;
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 16px;
        }

        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 100px;
            font-size: 13px;
            color: #999;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .stat-badge:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .streak-flame {
            color: #ff6b35;
        }

        .level-gem {
            color: #a78bfa;
        }

        .points-star {
            color: #fbbf24;
        }

        /* AI Brain Visualization */
        .ai-brain {
            width: 100%;
            height: 120px;
            margin: 30px 0;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .ai-metrics {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
            position: relative;
            z-index: 1;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .metric-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Focus Section */
        .focus-section {
            margin-bottom: 60px;
        }

        .section-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #666;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .focus-input-container {
            position: relative;
            margin-bottom: 40px;
        }

        .focus-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 0;
            font-size: 28px;
            font-weight: 300;
            color: white;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .focus-input:focus {
            border-bottom-color: rgba(255, 255, 255, 0.3);
        }

        .focus-input::placeholder {
            color: rgba(255, 255, 255, 0.2);
        }

        .focus-timer {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .timer-display {
            font-size: 20px;
            font-weight: 500;
            color: #999;
            font-variant-numeric: tabular-nums;
            min-width: 60px;
        }

        .timer-btn {
            padding: 10px 24px;
            background: #ffffff;
            color: #000000;
            border: none;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .timer-btn:hover {
            transform: scale(1.05);
            background: #f0f0f0;
        }

        .timer-btn.pause {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sound-toggle {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }

        .sound-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sound-toggle.muted {
            color: #666;
        }

        /* AI Predictions */
        .predictions-bar {
            display: flex;
            gap: 8px;
            margin: 20px 0;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            overflow-x: auto;
        }

        .prediction {
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            font-size: 12px;
            color: #a5b4fc;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .prediction:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        /* Goals Section */
        .goals-section {
            margin-bottom: 60px;
        }

        .add-goal-container {
            margin-bottom: 24px;
            position: relative;
        }

        .add-goal-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 15px;
            color: white;
            outline: none;
            transition: all 0.3s ease;
        }

        .add-goal-input:focus {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .add-goal-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .goal-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .goal-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .goal-item.completed {
            opacity: 0.4;
        }

        .goal-checkbox {
            width: 20px;
            height: 20px;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            margin-right: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .goal-item.completed .goal-checkbox {
            background: #ffffff;
            border-color: #ffffff;
        }

        .goal-item.completed .goal-checkbox::after {
            content: '‚úì';
            color: #000;
            font-size: 12px;
            font-weight: 600;
        }

        .goal-text {
            flex: 1;
            font-size: 15px;
            font-weight: 400;
        }

        .goal-item.completed .goal-text {
            text-decoration: line-through;
            color: #666;
        }

        .goal-points {
            font-size: 12px;
            color: #fbbf24;
            margin-left: 8px;
        }

        .goal-priority {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: rgba(255, 255, 255, 0.2);
        }

        .goal-priority.high {
            background: #ff6b35;
        }

        .goal-priority.medium {
            background: #ffd93d;
        }

        .goal-priority.low {
            background: #4ade80;
        }

        .breakdown-btn {
            width: 24px;
            height: 24px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 50%;
            color: #a5b4fc;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }

        .breakdown-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.1);
        }

        /* AI Assistant */
        .ai-section {
            padding: 24px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(167, 139, 250, 0.05));
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            margin-bottom: 40px;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .ai-indicator {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .ai-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .ai-message {
            font-size: 14px;
            line-height: 1.6;
            color: #ccc;
            white-space: pre-line;
            margin-bottom: 16px;
        }

        .ai-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .ai-action-btn {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #999;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            border: none;
            font-weight: 500;
        }

        .ai-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateY(-1px);
        }

        .ai-action-btn:active {
            transform: translateY(0);
        }

        /* Enhanced AI Features */
        .enhanced-prediction {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }

        .prediction-task {
            font-weight: 600;
            color: #a5b4fc;
            margin-bottom: 4px;
        }

        .prediction-confidence {
            font-size: 11px;
            color: #4ade80;
            margin-bottom: 4px;
        }

        .prediction-reason {
            font-size: 11px;
            color: #888;
            font-style: italic;
        }

        /* AI Insights Panel */
        .ai-insights-panel {
            background: rgba(167, 139, 250, 0.05);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .ai-insights-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .ai-insights-icon {
            width: 20px;
            height: 20px;
            background: rgba(167, 139, 250, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #a78bfa;
        }

        .ai-insights-title {
            font-size: 13px;
            font-weight: 600;
            color: #a78bfa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ai-insights-content {
            font-size: 12px;
            line-height: 1.5;
            color: #ccc;
        }

        /* Power-ups */
        .powerups {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .powerup-btn {
            flex: 1;
            padding: 8px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(167, 139, 250, 0.2));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .powerup-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(167, 139, 250, 0.3));
        }

        .powerup-btn.active {
            background: linear-gradient(135deg, #667eea, #a78bfa);
        }

        /* Progress */
        .progress-section {
            padding: 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            margin-bottom: 40px;
        }

        .progress-item {
            margin-bottom: 20px;
        }

        .progress-item:last-child {
            margin-bottom: 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 13px;
            color: #999;
        }

        .progress-value {
            font-size: 13px;
            color: #fff;
            font-weight: 500;
        }

        .progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.8));
            border-radius: 2px;
            transition: width 0.6s ease;
        }

        /* Floating Points Animation */
        .points-animation {
            position: fixed;
            font-size: 18px;
            font-weight: bold;
            color: #fbbf24;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
            z-index: 1000;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px);
            }
        }

        /* Level Up Modal */
        .level-up-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            border: 2px solid #a78bfa;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            z-index: 2000;
            animation: levelUpAnimation 0.5s ease;
        }

        @keyframes levelUpAnimation {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .level-up-title {
            font-size: 32px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #667eea, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .level-up-message {
            color: #999;
            margin-bottom: 20px;
        }

        .level-up-reward {
            font-size: 48px;
            margin-bottom: 20px;
        }

        /* Flow State Indicator */
        .flow-state {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 16px;
            background: rgba(167, 139, 250, 0.1);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 20px;
            font-size: 12px;
            color: #a78bfa;
            display: none;
        }

        .flow-state.active {
            display: block;
            animation: pulse 2s infinite;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideIn 0.5s ease;
            z-index: 1000;
            max-width: 300px;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                gap: 40px;
            }
            
            .analytics-sidebar {
                position: static;
                max-height: none;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 40px 20px;
                grid-template-columns: 1fr;
                gap: 40px;
            }
            
            .nav-items {
                justify-content: center;
                gap: 12px;
            }
            
            .nav-item {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .task-tabs {
                flex-direction: column;
                gap: 4px;
            }
            
            .task-tab {
                border-radius: 8px;
                text-align: center;
                justify-content: center;
            }
            
            .time {
                font-size: 36px;
            }
            
            .focus-input {
                font-size: 24px;
            }

            .ai-actions {
                grid-template-columns: 1fr;
            }

            .analytics-sidebar {
                padding: 16px;
            }

            .analytics-sidebar .section-label {
                font-size: 11px;
            }
        }

        /* Task Breakdown Modal */
        .task-breakdown-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }

        .task-breakdown-content {
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .breakdown-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .breakdown-header h3 {
            font-size: 24px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #667eea, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .original-task {
            font-size: 16px;
            color: #ccc;
            margin-bottom: 16px;
            font-style: italic;
        }

        .complexity-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .complexity-badge.high {
            background: rgba(255, 107, 53, 0.2);
            color: #ff6b35;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        .complexity-badge.medium {
            background: rgba(255, 217, 61, 0.2);
            color: #ffd93d;
            border: 1px solid rgba(255, 217, 61, 0.3);
        }

        .complexity-badge.low {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        .micro-tasks-list {
            margin-bottom: 24px;
        }

        .micro-task-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .micro-task-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .micro-task-item.completed {
            background: rgba(74, 222, 128, 0.1);
            border-color: rgba(74, 222, 128, 0.3);
            opacity: 0.8;
        }

        .micro-task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .micro-task-text {
            flex: 1;
            font-size: 14px;
            color: #fff;
            font-weight: 500;
            line-height: 1.4;
        }

        .micro-task-meta {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .time-estimate {
            font-size: 11px;
            color: #a78bfa;
            background: rgba(167, 139, 250, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .priority-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .priority-badge.high {
            background: rgba(255, 107, 53, 0.2);
            color: #ff6b35;
        }

        .priority-badge.medium {
            background: rgba(255, 217, 61, 0.2);
            color: #ffd93d;
        }

        .priority-badge.low {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .micro-task-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .add-to-goals-btn {
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 6px;
            color: #a5b4fc;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .add-to-goals-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }

        .add-to-goals-btn.added {
            background: rgba(74, 222, 128, 0.4);
            color: #22c55e;
            cursor: default;
        }

        .micro-task-progress {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .micro-task-progress .progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .micro-task-progress .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            border-radius: 3px;
            transition: width 0.6s ease;
        }

        .complete-micro-btn {
            padding: 6px 12px;
            background: rgba(74, 222, 128, 0.2);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 6px;
            color: #4ade80;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .complete-micro-btn:hover {
            background: rgba(74, 222, 128, 0.3);
            transform: translateY(-1px);
        }

        .complete-micro-btn.completed {
            background: rgba(74, 222, 128, 0.4);
            color: #22c55e;
            cursor: default;
        }

        .breakdown-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-primary {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea, #a78bfa);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        /* Breakdown Completion Notification */
        .breakdown-completion-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(34, 197, 94, 0.1));
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 16px;
            padding: 20px;
            max-width: 350px;
            z-index: 2000;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .completion-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .completion-icon {
            font-size: 32px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .completion-text h4 {
            color: #4ade80;
            margin-bottom: 4px;
            font-size: 16px;
        }

        .completion-text p {
            color: #ccc;
            font-size: 14px;
            margin: 0;
        }

        /* One Thing Progress */
        .one-thing-progress {
            margin-top: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 13px;
            color: #999;
        }

        .progress-value {
            font-size: 13px;
            color: #fff;
            font-weight: 500;
        }

        .progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.8));
            border-radius: 2px;
            transition: width 0.6s ease;
        }

        .micro-tasks-mini {
            margin-top: 16px;
        }

        .mini-task {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 13px;
            color: #ccc;
        }

        .mini-task:last-child {
            border-bottom: none;
        }

        .mini-task-text {
            flex: 1;
            line-height: 1.4;
        }

        .mini-task-time {
            font-size: 11px;
            color: #666;
            white-space: nowrap;
        }

        .mini-task.completed {
            opacity: 0.4;
        }

        /* ONE Thing Completion Notification */
        .one-thing-completion-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(34, 197, 94, 0.1));
            border: 2px solid rgba(74, 222, 128, 0.4);
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            z-index: 2000;
            animation: oneThingCompletion 0.6s ease;
            backdrop-filter: blur(20px);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            backdrop-filter: blur(2px);
        }
        .loading-card {
            background: rgba(20, 20, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            color: #d1d5db;
            display: flex;
            gap: 12px;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: #a5b4fc;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @keyframes oneThingCompletion {
            0% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.8); 
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.05); 
            }
            100% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1); 
            }
        }

        .one-thing-completion-notification .completion-content {
            text-align: center;
        }

        .one-thing-completion-notification .completion-icon {
            font-size: 48px;
            margin-bottom: 16px;
            animation: trophyBounce 1s infinite;
        }

        @keyframes trophyBounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }

        .one-thing-completion-notification .completion-text h4 {
            color: #4ade80;
            margin-bottom: 8px;
            font-size: 20px;
            font-weight: 600;
        }

        .one-thing-completion-notification .completion-text p {
            color: #fff;
            font-size: 16px;
            margin-bottom: 12px;
            font-style: italic;
        }

        .one-thing-completion-notification .completion-message {
            color: #4ade80;
            font-size: 14px;
            font-weight: 500;
        }

        /* Tasks Page */
        .tasks-content {
            max-width: 800px;
            padding: 40px 0;
        }

        .tasks-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .tasks-header h2 {
            font-size: 36px;
            font-weight: 600;
            margin: 0 0 12px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tasks-header p {
            color: #9ca3af;
            font-size: 16px;
            margin: 0;
        }

        .tasks-container {
            margin-top: 40px;
        }

        /* Task Tabs */
        .task-tabs {
            display: flex;
            gap: 8px;
            margin: 40px 0 30px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 20px;
        }

        .task-tab {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px 8px 0 0;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .task-tab:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }

        .task-tab.active {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.3);
            color: #a5b4fc;
            border-bottom-color: transparent;
        }

        .task-count {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .task-tab.active .task-count {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Tab Content */
        .task-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .task-tab-content.active {
            display: block;
        }

        /* Completed Tasks */
        .completed-tasks-container {
            margin-top: 20px;
        }

        .completed-task-card {
            background: rgba(34, 197, 94, 0.05);
            border: 1px solid rgba(34, 197, 94, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            position: relative;
        }

        .completed-task-card:hover {
            background: rgba(34, 197, 94, 0.08);
            transform: translateY(-1px);
        }

        .completed-task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .completed-task-text {
            font-size: 16px;
            font-weight: 500;
            color: #22c55e;
            text-decoration: line-through;
            opacity: 0.8;
        }

        .completed-task-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .completed-task-time {
            color: #86efac;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .completed-task-date {
            color: #86efac;
            font-size: 12px;
            opacity: 0.7;
        }

        .completed-task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .completed-task-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .restore-task-btn {
            background: rgba(102, 126, 234, 0.2);
            color: #a5b4fc;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .restore-task-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }

        .delete-task-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .delete-task-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
        }

        /* Date Grouping */
        .date-group {
            margin-bottom: 24px;
        }

        .date-header {
            color: #9ca3af;
            font-size: 14px;
            font-weight: 500;
            margin: 0 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Insights */
        .insights-container {
            margin-top: 20px;
        }

        .insight-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .insight-icon {
            font-size: 24px;
        }

        .insight-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }

        .insight-content {
            color: #d1d5db;
            line-height: 1.6;
        }

        .insight-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .insight-stat {
            text-align: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .insight-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #a5b4fc;
            margin-bottom: 4px;
        }

        .insight-stat-label {
            font-size: 12px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .goals-container {
            margin-top: 20px;
        }

        .goal-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            position: relative;
        }

        .goal-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .goal-text {
            font-size: 16px;
            font-weight: 500;
            color: #ffffff;
            line-height: 1.4;
            flex: 1;
        }

        .goal-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .goal-priority {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .goal-priority.high {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .goal-priority.medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .goal-priority.low {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .goal-time {
            color: #9ca3af;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .goal-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .goal-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .complete-goal-btn {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .complete-goal-btn:hover {
            background: rgba(34, 197, 94, 0.3);
            transform: translateY(-1px);
        }

        .breakdown-goal-btn {
            background: rgba(102, 126, 234, 0.2);
            color: #a5b4fc;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .breakdown-goal-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }

        .no-goals-message {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
            font-style: italic;
        }

        .no-goals-message .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .no-goals-message h3 {
            margin: 0 0 8px 0;
            color: #d1d5db;
            font-weight: 500;
        }

        .no-goals-message p {
            margin: 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <nav class="nav-bar">
            <div class="nav-items">
                <button class="nav-item active" onclick="showPage('home')" id="homeNav">
                    üè† Home
                </button>
                <button class="nav-item" onclick="showPage('tasks')" id="tasksNav">
                    üéØ Tasks
                </button>
            </div>
        </nav>

        <!-- Home Page -->
        <div class="page" id="homePage">
        <div class="main-content">
            <!-- Clean Minimalist Header -->
            <div class="header">
                <div class="time" id="time">9:42</div>
                <div class="date" id="date">Tuesday, January 14</div>
            </div>

            <!-- Today's Focus Section -->
            <div class="focus-section">
                <div class="section-label">TODAY'S FOCUS</div>
                <div class="focus-input-container">
                    <input 
                        type="text" 
                        class="focus-input" 
                        id="focusInput"
                        placeholder="What's your ONE thing today?"
                        onkeypress="handleFocusEnter(event)"
                    >
                </div>
                <div class="focus-timer">
                    <div class="timer-display" id="timerDisplay">25:00</div>
                    <button class="timer-btn" id="timerBtn" onclick="toggleTimer()">Start Focus</button>
                    <button class="reset-btn" onclick="resetTimer()">Reset</button>
                </div>
            </div>


        </div>
        </div>

        <!-- Tasks Page -->
        <div class="page hidden" id="tasksPage">
            <div class="tasks-content">
                <div class="tasks-header">
                    <h2>üéØ Task Management</h2>
                    <p>Manage your current goals and track progress</p>
                </div>
                
                <!-- Task Tabs -->
                <div class="task-tabs">
                    <button class="task-tab active" onclick="showTaskTab('active')" id="activeTab">
                        üî• Active Tasks
                        <span class="task-count" id="activeTaskCount">0</span>
                    </button>
                    <button class="task-tab" onclick="showTaskTab('completed')" id="completedTab">
                        ‚úÖ Completed
                        <span class="task-count" id="completedTaskCount">0</span>
                    </button>
                    <button class="task-tab" onclick="showTaskTab('insights')" id="insightsTab">
                        üìä Insights
                    </button>
                </div>
                
                <!-- Active Tasks Tab -->
                <div class="task-tab-content active" id="activeTabContent">
                    <div class="goals-container" id="activeGoalsContainer">
                        <!-- Active goals will be populated here -->
                    </div>
                </div>
                
                <!-- Completed Tasks Tab -->
                <div class="task-tab-content" id="completedTabContent">
                    <div class="completed-tasks-container" id="completedTasksContainer">
                        <!-- Completed tasks will be populated here -->
                    </div>
                </div>
                
                <!-- Insights Tab -->
                <div class="task-tab-content" id="insightsTabContent">
                    <div class="insights-container" id="insightsContainer">
                        <!-- Task insights will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="analytics-sidebar">
            <!-- AI Status Indicator -->
            <div class="ai-status">
                <div class="ai-indicator"></div>
                <span>AI Learning Your Patterns</span>
            </div>

            <!-- Stats Row -->
            <div class="stats-row">
                <div class="stat-badge" onclick="showStreakDetails()">
                    <span class="streak-flame">üî•</span>
                    <span id="streakCount">12 day streak</span>
                </div>
                <div class="stat-badge" onclick="showLevelProgress()">
                    <span class="level-gem">üíé</span>
                    <span id="levelDisplay">Level 7</span>
                </div>
                <div class="stat-badge" onclick="showPointsBreakdown()">
                    <span class="points-star">‚≠ê</span>
                    <span id="pointsDisplay">2,450 pts</span>
                </div>
            </div>

            <!-- AI Brain Visualization -->
            <div class="ai-brain">
                <div class="ai-metrics">
                    <div class="metric">
                        <div class="metric-value" id="focusScore">87%</div>
                        <div class="metric-label">Focus Score</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="flowTime">47m</div>
                        <div class="metric-label">Avg Flow State</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="completion">73%</div>
                        <div class="metric-label">Completion Rate</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="momentum">+15%</div>
                        <div class="metric-label">Weekly Growth</div>
                    </div>
                </div>
            </div>

            <!-- Real-time AI Insights -->
            <div class="ai-insights-panel">
                <div class="ai-insights-header">
                    <div class="ai-insights-icon">üß†</div>
                    <div class="ai-insights-title">AI Insights</div>
                </div>
                <div class="ai-insights-content">
                    <div id="aiInsightsContent">
                        Analyzing your patterns...
                    </div>
                </div>
            </div>

            <!-- AI Predictions Bar -->
            <div class="predictions-bar" id="predictionsBar">
                <div class="prediction" onclick="adoptPrediction('Review quarterly goals')">Review quarterly goals ‚Ä¢ 85%</div>
                <div class="prediction" onclick="adoptPrediction('Team standup preparation')">Team standup preparation ‚Ä¢ 72%</div>
                <div class="prediction" onclick="adoptPrediction('Deep work block')">Deep work block ‚Ä¢ 94%</div>
            </div>

            <!-- AI Assistant -->
            <div class="ai-section" id="aiSection">
                <div class="ai-header">
                    <div class="ai-indicator"></div>
                    <div class="ai-label">AI Coach</div>
                </div>
                <div class="ai-message" id="aiMessage">
                    Good morning! Your cognitive performance peaks in 18 minutes. Based on your patterns, Tuesday mornings show 40% higher completion rates. Your ONE Thing approach will cascade into 3-4 easier wins today.
                </div>
                <div class="ai-actions">
                    <button class="ai-action-btn" onclick="enhancedPredictNext()">üîÆ Predict Next</button>
                    <button class="ai-action-btn" onclick="enhancedEnergyOptimization()">‚ö° Energy</button>
                    <button class="ai-action-btn" onclick="enhancedFlowTriggers()">üåä Flow</button>
                    <button class="ai-action-btn" onclick="analyzeBlockers()">üö´ Blockers</button>
                    <button class="ai-action-btn" onclick="suggestBreak()">‚òï Break</button>
                    <button class="ai-action-btn" onclick="enhancedWeeklyReview()">üìä Weekly</button>
                </div>
            </div>

            <!-- Power-ups -->
            <div class="powerups">
                <div class="powerup-btn" onclick="activatePowerUp('focus', this)" title="2x points for 30 min">
                    ‚ö° Focus Boost
                </div>
                <div class="powerup-btn" onclick="activatePowerUp('streak', this)" title="Protect your streak">
                    üõ°Ô∏è Streak Shield
                </div>
                <div class="powerup-btn" onclick="activatePowerUp('time', this)" title="Pause time for planning">
                    ‚è∞ Time Freeze
                </div>
                <div class="powerup-btn" onclick="activatePowerUp('wisdom', this)" title="Get expert advice">
                    üß† Wisdom Mode
                </div>
            </div>

            <!-- Progress -->
            <div class="progress-section">
                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">Daily Progress</span>
                        <span class="progress-value" id="dailyProgress">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="dailyProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">Weekly Momentum</span>
                        <span class="progress-value">72%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 72%"></div>
                    </div>
                </div>
                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">Level Progress</span>
                        <span class="progress-value" id="levelProgress">450/500 XP</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="levelProgressBar" style="width: 90%"></div>
                    </div>
                </div>
            </div>

            <!-- Additional Analytics -->
            <div class="section-label">Your Analytics</div>
            <div class="progress-section">
                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">Daily Focus Time</span>
                        <span class="progress-value" id="dailyFocusTime">0m</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="dailyFocusTimeBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">Weekly Flow State</span>
                        <span class="progress-value" id="weeklyFlowState">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="weeklyFlowStateBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">Achievements</span>
                        <span class="progress-value" id="achievementsCount">0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="achievementsBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="section-label">Recent Activity</div>
            <div class="activity-log" id="activityLog">
                <!-- Activity will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- Flow State Indicator -->
    <div class="flow-state" id="flowState">
        üåä Flow State Active
    </div>
    
    <!-- Data Management Buttons -->
    <div style="position: fixed; bottom: 20px; left: 20px; display: flex; gap: 10px;">
        <button class="btn" onclick="exportData()" title="Export your data">
            üíæ Export
        </button>
        <button class="btn" onclick="document.getElementById('importFile').click()" title="Import backup">
            üìÇ Import
        </button>
        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(this.files[0])">
        <button class="btn" onclick="resetProgress()" title="Reset all progress">
            üîÑ Reset
        </button>
    </div>

    <script>
        // LocalStorage Key
        const STORAGE_KEY = 'focusAppData';
        
        // Load saved data or use defaults
        function loadGameState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // Check if it's from today
                    const today = new Date().toDateString();
                    if (data.lastSaved !== today) {
                        // New day - reset daily progress but keep streak
                        data.gameState.streak = calculateStreak(data.lastSaved);
                        data.goals = data.goals.filter(g => g.isOneThing || !g.completed);
                        data.gameState.powerUps = {
                            focus: false,
                            streak: false,
                            time: false,
                            wisdom: false
                        };
                    }
                    return data;
                } catch (e) {
                    console.error('Failed to load saved data:', e);
                }
            }
            return null;
        }
        
        function calculateStreak(lastSaved) {
            const last = new Date(lastSaved);
            const today = new Date();
            const diffTime = Math.abs(today - last);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                return gameState.streak + 1; // Consecutive day
            } else if (diffDays > 1) {
                return 1; // Streak broken, start over
            }
            return gameState.streak; // Same day
        }
        
        // Load saved data or initialize defaults
        const savedData = loadGameState();
        
        let gameState = savedData?.gameState || {
            points: 0,
            level: 1,
            levelXP: 0,
            levelXPRequired: 100,
            streak: 1,
            soundEnabled: true,
            flowStateActive: false,
            powerUps: {
                focus: false,
                streak: false,
                time: false,
                wisdom: false
            },
            aiMetrics: {
                focusScore: 50,
                avgFlowTime: 25,
                completionRate: 0,
                weeklyGrowth: 0
            },
            totalTasksCompleted: 0,
            totalFocusSessions: 0,
            totalFocusTime: 0,
            bestStreak: 1,
            achievements: {},
            firstVisit: new Date().toISOString()
        };

        // Goals array
        let goals = savedData?.goals || [];
        let goalIdCounter = savedData?.goalIdCounter || 0;
        
        // Statistics tracking
        let statistics = savedData?.statistics || {
            dailyStats: {},
            weeklyStats: {},
            monthlyStats: {},
            allTimeStats: {
                totalPoints: gameState.points,
                totalTasks: gameState.totalTasksCompleted,
                totalFocusMinutes: 0,
                averageTasksPerDay: 0,
                mostProductiveHour: 9,
                mostProductiveDay: 'Monday'
            }
        };
        
        // Save state to localStorage
        function saveState() {
            const dataToSave = {
                gameState: gameState,
                goals: goals,
                goalIdCounter: goalIdCounter,
                statistics: statistics,
                lastSaved: new Date().toDateString(),
                version: '1.0.0'
            };
            
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                // Show save indicator
                showSaveIndicator();
            } catch (e) {
                console.error('Failed to save data:', e);
                if (e.name === 'QuotaExceededError') {
                    // Clear old data if storage is full
                    clearOldData();
                }
            }
        }
        
        // Auto-save every 30 seconds
        setInterval(saveState, 30000);
        
        // Save on important events
        function saveOnEvent() {
            saveState();
        }
        
        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.createElement('div');
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                padding: 5px 10px;
                background: rgba(74, 222, 128, 0.2);
                border: 1px solid rgba(74, 222, 128, 0.5);
                border-radius: 5px;
                color: #4ade80;
                font-size: 12px;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            indicator.textContent = '‚úì Saved';
            document.body.appendChild(indicator);
            
            setTimeout(() => indicator.remove(), 2000);
        }
        
        // Clear old data if needed
        function clearOldData() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            // Keep only last 30 days of statistics
            if (statistics.dailyStats) {
                Object.keys(statistics.dailyStats).forEach(date => {
                    if (new Date(date) < thirtyDaysAgo) {
                        delete statistics.dailyStats[date];
                    }
                });
            }
            
            saveState();
        }
        
        // Export data function
        function exportData() {
            const dataStr = JSON.stringify({
                gameState,
                goals,
                statistics,
                exportDate: new Date().toISOString()
            }, null, 2);
            
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `focus-app-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            updateAI('Data exported successfully! Keep this file safe for backup.');
        }
        
        // Import data function
        function importData(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    gameState = imported.gameState || gameState;
                    goals = imported.goals || goals;
                    statistics = imported.statistics || statistics;
                    
                    saveState();
                    updateDisplay();
                    renderGoals();
                    updateAI('Data imported successfully! Your progress has been restored.');
                } catch (error) {
                    updateAI('Failed to import data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        // Timer variables
        let timeLeft = 25 * 60;
        let timerInterval = null;
        let isRunning = false;

        // Audio context for sounds
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Time and Date Update
        function updateTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('time').textContent = `${hours}:${minutes}`;
            
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            document.getElementById('date').textContent = now.toLocaleDateString('en-US', options);
        }

        updateTime();
        setInterval(updateTime, 1000);

        // Timer Functions
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function toggleTimer() {
            const btn = document.getElementById('timerBtn');
            if (!isRunning) {
                isRunning = true;
                btn.textContent = 'Pause';
                btn.classList.add('pause');
                startTimer();
            } else {
                isRunning = false;
                btn.textContent = 'Resume';
                btn.classList.remove('pause');
                pauseTimer();
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft % 5 === 0 && gameState.soundEnabled) {
                        playTick();
                    }
                } else {
                    completeSession();
                }
            }, 1000);

            // Check for flow state after 10 minutes
            setTimeout(() => {
                if (isRunning && timeLeft > 0) {
                    enterFlowState();
                }
            }, 10 * 60 * 1000);
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function completeSession() {
            isRunning = false;
            document.getElementById('timerBtn').textContent = 'Start Focus';
            document.getElementById('timerBtn').classList.remove('pause');
            clearInterval(timerInterval);
            
            // Track focus session
            gameState.totalFocusSessions++;
            gameState.totalFocusTime += 25;
            
            const today = new Date().toDateString();
            if (!statistics.dailyStats[today]) {
                statistics.dailyStats[today] = { points: 0, tasks: 0, focusMinutes: 0, flowStates: 0 };
            }
            statistics.dailyStats[today].focusMinutes += 25;
            if (gameState.flowStateActive) {
                statistics.dailyStats[today].flowStates = 1;
            }
            
            timeLeft = 25 * 60;
            updateTimerDisplay();
            
            // Award points
            const points = gameState.powerUps.focus ? 200 : 100;
            addPoints(points);
            
            updateAI(`Excellent focus session! You earned ${points} points. ${gameState.flowStateActive ? 'üåä Flow state achieved!' : ''} Take a 5-minute break.`);
            
            gameState.flowStateActive = false;
            document.getElementById('flowState').classList.remove('active');
            
            playCompletionSound();
            updateAnalytics();
            renderActivityLog();
            updateAIMood(); // Update AI mood after session
            saveOnEvent(); // Save after session
        }

        function playTick() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.05);
        }

        function playCompletionSound() {
            if (!gameState.soundEnabled) return;
            
            const notes = [523.25, 659.25, 783.99];
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioContext.currentTime + 0.3);
                }, i * 100);
            });
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            const btn = document.getElementById('soundToggle');
            btn.textContent = gameState.soundEnabled ? 'üîä' : 'üîá';
            btn.classList.toggle('muted', !gameState.soundEnabled);
        }

        function enterFlowState() {
            gameState.flowStateActive = true;
            document.getElementById('flowState').classList.add('active');
            updateAI("üåä Flow state detected! You're in the zone. Distractions blocked, cognitive performance optimal.");
            
            // Increase focus score
            gameState.aiMetrics.focusScore = Math.min(100, gameState.aiMetrics.focusScore + 5);
            document.getElementById('focusScore').textContent = gameState.aiMetrics.focusScore + '%';
        }

        // Goal Management
        async function handleFocusEnter(e) {
            if (e.key === 'Enter' && e.target.value.trim()) {
                const taskText = e.target.value.trim();
                
                // Try research-powered breakdown first
                showLoadingOverlay('Analyzing with AI...');
                try {
                    const resp = await fetch('/api/research-breakdown', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task: taskText })
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        const aiBreakdown = (data.breakdown || []).map(item => ({
                            id: ++microTaskIdCounter,
                            text: item.text,
                            estimatedTime: item.estimatedTime,
                            priority: item.priority || 'medium',
                            completed: false
                        }));
                        const taskId = Date.now();
                        taskBreakdowns[taskId] = {
                            originalTask: taskText,
                            complexity: 'ai',
                            microTasks: aiBreakdown,
                            createdAt: new Date(),
                            completed: 0,
                            total: aiBreakdown.length,
                            sources: data.sources || []
                        };
                        hideLoadingOverlay();
                        showTaskBreakdown(taskId, aiBreakdown, taskText);
                        // Clear input
                        e.target.value = '';
                        return;
                    }
                } catch (err) {
                    // fall back
                } finally {
                    hideLoadingOverlay();
                }
                
                // Fallback to local heuristic breakdown
                const { taskId, breakdown } = analyzeAndBreakdownTask(taskText);
                showTaskBreakdown(taskId, breakdown, taskText);
                e.target.value = '';
            }
        }

        // Smart Task Breakdown System
        let taskBreakdowns = {};
        let microTaskIdCounter = 0;

        // AI Task Analysis and Breakdown
        function analyzeAndBreakdownTask(taskText) {
            const complexity = analyzeTaskComplexity(taskText);
            const breakdown = generateMicroTasks(taskText, complexity);
            
            // Store the breakdown
            const taskId = Date.now();
            taskBreakdowns[taskId] = {
                originalTask: taskText,
                complexity: complexity,
                microTasks: breakdown,
                createdAt: new Date(),
                completed: 0,
                total: breakdown.length
            };
            
            return { taskId, breakdown };
        }

        // Analyze task complexity
        function analyzeTaskComplexity(taskText) {
            const text = taskText.toLowerCase();
            let complexity = 'simple';
            
            // Complexity indicators
            if (text.includes('project') || text.includes('plan') || text.includes('strategy')) {
                complexity = 'complex';
            } else if (text.includes('review') || text.includes('analyze') || text.includes('research')) {
                complexity = 'moderate';
            } else if (text.includes('email') || text.includes('call') || text.includes('meeting')) {
                complexity = 'simple';
            }
            
            // Time indicators
            if (text.includes('week') || text.includes('month') || text.includes('quarter')) {
                complexity = 'complex';
            } else if (text.includes('today') || text.includes('tomorrow')) {
                complexity = 'moderate';
            }
            
            // Action indicators
            if (text.includes('create') && text.includes('system')) {
                complexity = 'complex';
            } else if (text.includes('organize') || text.includes('clean')) {
                complexity = 'moderate';
            }
            
            return complexity;
        }

        // Intelligent context-aware micro-task generation
        function generateMicroTasks(taskText, complexity) {
            const parsedTask = parseTaskContext(taskText);
            return generateContextualMicroTasks(parsedTask, complexity);
        }

        // Parse task context and extract meaningful information
        function parseTaskContext(taskText) {
            const text = taskText.toLowerCase();
            
            return {
                originalText: taskText,
                action: extractAction(text),
                subject: extractSubject(text),
                domain: extractDomain(text),
                timeframe: extractTimeframe(text),
                scope: extractScope(text),
                deliverable: extractDeliverable(text)
            };
        }

        function extractAction(text) {
            const actions = {
                'create': ['create', 'build', 'develop', 'make', 'design', 'construct'],
                'plan': ['plan', 'strategy', 'roadmap', 'outline', 'blueprint'],
                'analyze': ['analyze', 'review', 'evaluate', 'assess', 'examine', 'study'],
                'organize': ['organize', 'clean', 'sort', 'structure', 'arrange'],
                'write': ['write', 'draft', 'compose', 'document', 'author'],
                'research': ['research', 'investigate', 'explore', 'discover', 'find'],
                'implement': ['implement', 'execute', 'deploy', 'launch', 'rollout'],
                'improve': ['improve', 'optimize', 'enhance', 'upgrade', 'refactor'],
                'learn': ['learn', 'study', 'master', 'understand', 'practice'],
                'prepare': ['prepare', 'setup', 'configure', 'ready']
            };
            
            for (const [action, keywords] of Object.entries(actions)) {
                if (keywords.some(keyword => text.includes(keyword))) {
                    return action;
                }
            }
            return 'execute';
        }

        function extractSubject(text) {
            // Extract key nouns and subjects
            const subjects = {
                'presentation': ['presentation', 'slides', 'deck', 'pitch'],
                'report': ['report', 'analysis', 'summary', 'documentation'],
                'website': ['website', 'site', 'web', 'landing page'],
                'app': ['app', 'application', 'software', 'tool'],
                'marketing': ['marketing', 'campaign', 'promotion', 'advertising'],
                'database': ['database', 'data', 'sql', 'records'],
                'email': ['email', 'message', 'communication', 'outreach'],
                'meeting': ['meeting', 'call', 'conference', 'discussion'],
                'budget': ['budget', 'financial', 'cost', 'expense'],
                'training': ['training', 'workshop', 'course', 'education'],
                'project': ['project', 'initiative', 'program'],
                'system': ['system', 'process', 'workflow', 'procedure']
            };
            
            for (const [subject, keywords] of Object.entries(subjects)) {
                if (keywords.some(keyword => text.includes(keyword))) {
                    return subject;
                }
            }
            return 'general';
        }

        function extractDomain(text) {
            const domains = {
                'business': ['business', 'strategy', 'revenue', 'profit', 'market'],
                'technology': ['tech', 'software', 'code', 'programming', 'development'],
                'design': ['design', 'ui', 'ux', 'visual', 'creative'],
                'marketing': ['marketing', 'social media', 'content', 'seo', 'brand'],
                'finance': ['finance', 'accounting', 'budget', 'investment'],
                'hr': ['hr', 'human resources', 'hiring', 'recruitment', 'team'],
                'operations': ['operations', 'logistics', 'supply', 'process'],
                'sales': ['sales', 'selling', 'client', 'customer', 'lead']
            };
            
            for (const [domain, keywords] of Object.entries(domains)) {
                if (keywords.some(keyword => text.includes(keyword))) {
                    return domain;
                }
            }
            return 'general';
        }

        function extractTimeframe(text) {
            if (text.includes('urgent') || text.includes('asap') || text.includes('immediate')) return 'urgent';
            if (text.includes('today') || text.includes('now')) return 'today';
            if (text.includes('week')) return 'week';
            if (text.includes('month') || text.includes('quarter')) return 'month';
            return 'normal';
        }

        function extractScope(text) {
            if (text.includes('small') || text.includes('quick') || text.includes('simple')) return 'small';
            if (text.includes('large') || text.includes('complex') || text.includes('comprehensive')) return 'large';
            return 'medium';
        }

        function extractDeliverable(text) {
            const deliverables = {
                'document': ['document', 'report', 'guide', 'manual'],
                'presentation': ['presentation', 'slides', 'demo'],
                'product': ['product', 'feature', 'tool', 'app'],
                'plan': ['plan', 'strategy', 'roadmap'],
                'system': ['system', 'process', 'workflow']
            };
            
            for (const [deliverable, keywords] of Object.entries(deliverables)) {
                if (keywords.some(keyword => text.includes(keyword))) {
                    return deliverable;
                }
            }
            return 'outcome';
        }

        // Generate contextual micro-tasks based on parsed information
        function generateContextualMicroTasks(parsedTask, complexity) {
            const { action, subject, domain, timeframe, scope, deliverable, originalText } = parsedTask;
            
            // Determine number of tasks based on complexity
            const taskCount = complexity === 'complex' ? 5 : complexity === 'moderate' ? 4 : 3;
            
            // Generate specific micro-tasks based on context
            let microTasks = [];
            
            if (action === 'create' && subject === 'presentation') {
                microTasks = [
                    { text: "Define presentation objectives and key messages", estimatedTime: 15, priority: 'high' },
                    { text: "Research content and gather supporting materials", estimatedTime: 20, priority: 'high' },
                    { text: "Create presentation outline and structure", estimatedTime: 15, priority: 'high' },
                    { text: "Design slides and visual elements", estimatedTime: 25, priority: 'medium' },
                    { text: "Practice and refine presentation delivery", estimatedTime: 15, priority: 'medium' }
                ];
            } else if (action === 'create' && subject === 'website') {
                microTasks = [
                    { text: "Define website requirements and target audience", estimatedTime: 20, priority: 'high' },
                    { text: "Create wireframes and site structure", estimatedTime: 25, priority: 'high' },
                    { text: "Design visual mockups and user interface", estimatedTime: 30, priority: 'medium' },
                    { text: "Develop and code the website", estimatedTime: 45, priority: 'medium' },
                    { text: "Test functionality and deploy", estimatedTime: 20, priority: 'low' }
                ];
            } else if (action === 'write' && subject === 'report') {
                microTasks = [
                    { text: "Gather all relevant data and sources", estimatedTime: 20, priority: 'high' },
                    { text: "Create report outline and structure", estimatedTime: 15, priority: 'high' },
                    { text: "Write first draft of main sections", estimatedTime: 30, priority: 'medium' },
                    { text: "Review, edit and refine content", estimatedTime: 20, priority: 'medium' }
                ];
            } else if (action === 'plan' && domain === 'marketing') {
                microTasks = [
                    { text: "Analyze target audience and market research", estimatedTime: 25, priority: 'high' },
                    { text: "Define marketing objectives and KPIs", estimatedTime: 15, priority: 'high' },
                    { text: "Develop marketing strategies and tactics", estimatedTime: 30, priority: 'medium' },
                    { text: "Create content calendar and timeline", estimatedTime: 20, priority: 'medium' },
                    { text: "Set budget allocation and resource plan", estimatedTime: 15, priority: 'low' }
                ];
            } else if (action === 'organize' && subject === 'email') {
                microTasks = [
                    { text: "Review current email organization system", estimatedTime: 10, priority: 'high' },
                    { text: "Create folder structure and labeling system", estimatedTime: 15, priority: 'high' },
                    { text: "Sort and categorize existing emails", estimatedTime: 25, priority: 'medium' },
                    { text: "Set up filters and automation rules", estimatedTime: 15, priority: 'low' }
                ];
            } else if (action === 'learn' || subject === 'training') {
                microTasks = [
                    { text: "Identify specific learning objectives and goals", estimatedTime: 10, priority: 'high' },
                    { text: "Research and gather learning resources", estimatedTime: 15, priority: 'high' },
                    { text: "Create study schedule and practice plan", estimatedTime: 15, priority: 'medium' },
                    { text: "Complete hands-on exercises and practice", estimatedTime: 30, priority: 'medium' }
                ];
            } else if (action === 'implement' && domain === 'technology') {
                microTasks = [
                    { text: "Review technical requirements and specifications", estimatedTime: 15, priority: 'high' },
                    { text: "Set up development environment and tools", estimatedTime: 20, priority: 'high' },
                    { text: "Code and develop core functionality", estimatedTime: 35, priority: 'medium' },
                    { text: "Test, debug and optimize implementation", estimatedTime: 20, priority: 'medium' },
                    { text: "Deploy and document the solution", estimatedTime: 15, priority: 'low' }
                ];
            } else {
                // Intelligent fallback based on action and context
                microTasks = generateIntelligentFallback(parsedTask, taskCount);
            }
            
            // Trim to appropriate number of tasks and add IDs
            microTasks = microTasks.slice(0, taskCount).map(task => ({
                id: ++microTaskIdCounter,
                ...task
            }));
            
            // Adjust time estimates based on scope
            if (scope === 'small') {
                microTasks.forEach(task => task.estimatedTime = Math.max(5, Math.round(task.estimatedTime * 0.7)));
            } else if (scope === 'large') {
                microTasks.forEach(task => task.estimatedTime = Math.round(task.estimatedTime * 1.5));
            }
            
            return microTasks;
        }

        function generateIntelligentFallback(parsedTask, taskCount) {
            const { action, subject, originalText } = parsedTask;
            
            // Extract key terms for more specific tasks
            const taskWords = originalText.toLowerCase().match(/\b\w+\b/g);
            const importantWords = taskWords.filter(word => 
                word.length > 3 && 
                !['this', 'that', 'with', 'from', 'they', 'have', 'will', 'been', 'were', 'said'].includes(word)
            );
            
            const mainSubject = importantWords.find(word => 
                ['project', 'report', 'system', 'process', 'plan', 'strategy', 'website', 'app'].includes(word)
            ) || subject;
            
            let baseTasks = [];
            
            if (action === 'create' || action === 'build') {
                baseTasks = [
                    { text: `Research requirements for ${mainSubject}`, estimatedTime: 15, priority: 'high' },
                    { text: `Plan structure and approach for ${mainSubject}`, estimatedTime: 20, priority: 'high' },
                    { text: `Develop initial version of ${mainSubject}`, estimatedTime: 25, priority: 'medium' },
                    { text: `Review and refine ${mainSubject}`, estimatedTime: 15, priority: 'medium' },
                    { text: `Finalize and prepare ${mainSubject} for delivery`, estimatedTime: 10, priority: 'low' }
                ];
            } else if (action === 'analyze' || action === 'review') {
                baseTasks = [
                    { text: `Collect all materials related to ${mainSubject}`, estimatedTime: 10, priority: 'high' },
                    { text: `Analyze key aspects of ${mainSubject}`, estimatedTime: 20, priority: 'high' },
                    { text: `Identify insights and patterns in ${mainSubject}`, estimatedTime: 15, priority: 'medium' },
                    { text: `Document findings and recommendations`, estimatedTime: 15, priority: 'medium' }
                ];
            } else {
                baseTasks = [
                    { text: `Understand requirements for "${originalText}"`, estimatedTime: 10, priority: 'high' },
                    { text: `Plan approach and gather resources`, estimatedTime: 15, priority: 'high' },
                    { text: `Execute main work on the task`, estimatedTime: 20, priority: 'medium' },
                    { text: `Review and complete final steps`, estimatedTime: 10, priority: 'low' }
                ];
            }
            
            return baseTasks;
        }

        // Enhanced goal handling with task breakdown
        function handleGoalEnter(e) {
            if (e.key === 'Enter' && e.target.value.trim()) {
                const taskText = e.target.value.trim();
                
                // Analyze and breakdown the task
                const { taskId, breakdown } = analyzeAndBreakdownTask(taskText);
                
                // Show breakdown to user
                showTaskBreakdown(taskId, breakdown, taskText);
                
                // Clear input
                e.target.value = '';
            }
        }

        // Show task breakdown modal
        function showTaskBreakdown(taskId, breakdown, originalTask) {
            const modal = document.createElement('div');
            modal.className = 'task-breakdown-modal';
            modal.innerHTML = `
                <div class="task-breakdown-content">
                    <div class="breakdown-header">
                        <h3>üéØ Your ONE Thing Breakdown</h3>
                        <p class="original-task">"${originalTask}"</p>
                        <div class="complexity-badge ${breakdown[0]?.priority || 'medium'}">
                            ${breakdown.length} micro-tasks ‚Ä¢ ${breakdown.reduce((sum, task) => sum + task.estimatedTime, 0)} min total
                        </div>
                    </div>
                    <div id="breakdownSources" class="breakdown-sources"></div>
                    
                    <div class="micro-tasks-list">
                        ${breakdown.map(task => `
                            <div class="micro-task-item" data-task-id="${task.id}">
                                <div class="micro-task-header">
                                    <div class="micro-task-text">${task.text}</div>
                                    <div class="micro-task-meta">
                                        <span class="time-estimate">${task.estimatedTime}m</span>
                                        <span class="priority-badge ${task.priority}">${task.priority}</span>
                                    </div>
                                </div>
                                <div class="micro-task-actions">
                                    <button class="add-to-goals-btn" onclick="addMicroTaskToGoals(${task.id}, ${taskId}, '${task.text}', ${task.estimatedTime}, '${task.priority}')">
                                        ‚ûï Add to Goals
                                    </button>
                                    <button class="complete-micro-btn" onclick="completeMicroTask(${task.id}, ${taskId})">
                                        Complete
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="breakdown-actions">
                        <button class="btn-secondary" onclick="this.closest('.task-breakdown-modal').remove()">
                            Close
                        </button>
                        <button class="btn-primary" onclick="setAsOneThing(${taskId}, '${originalTask}')">
                            Set as Today's ONE Thing
                        </button>
                        <button class="btn-secondary" onclick="addAllMicroTasks(${taskId})">
                            Add All to Goals
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            // Populate sources if available
            const data = taskBreakdowns[taskId];
            if (data && Array.isArray(data.sources) && data.sources.length) {
                const sourcesDiv = modal.querySelector('#breakdownSources');
                sourcesDiv.innerHTML = `
                    <div style="margin: 10px 0 20px 0; color: #9ca3af; font-size: 12px;">
                        Sources:
                        ${data.sources.map(s => `<a href="${s.url}" target="_blank" style="color:#a5b4fc; margin-left:8px;">${s.title || 'Link'}</a>`).join('')}
                    </div>
                `;
            }
        }

        // Complete individual micro-task
        function completeMicroTask(microTaskId, breakdownId) {
            const breakdown = taskBreakdowns[breakdownId];
            if (!breakdown) return;
            
            const microTask = breakdown.microTasks.find(t => t.id === microTaskId);
            if (!microTask) return;
            
            // Mark as completed
            microTask.completed = true;
            breakdown.completed++;
            
            // Update UI
            const taskElement = document.querySelector(`[data-task-id="${microTaskId}"]`);
            if (taskElement) {
                taskElement.classList.add('completed');
                const progressBar = taskElement.querySelector('.progress-fill');
                const completeBtn = taskElement.querySelector('.complete-micro-btn');
                
                progressBar.style.width = '100%';
                completeBtn.textContent = '‚úì Done';
                completeBtn.disabled = true;
                completeBtn.classList.add('completed');
            }
            
            // Update ONE thing progress if it exists
            updateOneThingProgress(breakdownId);
            
            // Check if all micro-tasks are complete
            if (breakdown.completed === breakdown.total) {
                showBreakdownCompletion(breakdownId);
                completeOneThing(breakdownId);
            }
            
            // Update analytics
            updateAnalytics();
        }

        // Add all micro-tasks to goals
        function addAllMicroTasks(breakdownId) {
            const breakdown = taskBreakdowns[breakdownId];
            if (!breakdown) return;
            
            breakdown.microTasks.forEach(microTask => {
                const goal = {
                    id: ++goalIdCounter,
                    text: microTask.text,
                    completed: false,
                    priority: microTask.priority,
                    points: microTask.estimatedTime * 2, // Points based on time
                    isOneThing: false,
                    estimatedTime: microTask.estimatedTime,
                    parentBreakdown: breakdownId
                };
                
                goals.push(goal);
            });
            
            // Close modal and update display
            document.querySelector('.task-breakdown-modal').remove();
            renderGoals();
            updateProgress();
            
            // Show success message
            updateAI(`‚úÖ Added ${breakdown.microTasks.length} micro-tasks to your goals! This breakdown will make "${breakdown.originalTask}" much more manageable.`);
        }

        // Show breakdown completion celebration
        function showBreakdownCompletion(breakdownId) {
            const breakdown = taskBreakdowns[breakdownId];
            if (!breakdown) return;
            
            const notification = document.createElement('div');
            notification.className = 'breakdown-completion-notification';
            notification.innerHTML = `
                <div class="completion-content">
                    <div class="completion-icon">üéâ</div>
                    <div class="completion-text">
                        <h4>Task Completed!</h4>
                        <p>"${breakdown.originalTask}" - All ${breakdown.total} micro-tasks finished!</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function renderGoals() {
            const container = document.getElementById('goalsList');
            container.innerHTML = goals.map(goal => `
                <div class="goal-item ${goal.completed ? 'completed' : ''}" onclick="toggleGoal(${goal.id})">
                    <div class="goal-priority ${goal.priority}"></div>
                    <div class="goal-checkbox"></div>
                    <div class="goal-text">${goal.text}</div>
                    <div class="goal-points">+${goal.points} pts</div>
                    <button class="breakdown-btn" onclick="event.stopPropagation(); breakdownGoal(${goal.id})" title="Break down this task">
                        üîç
                    </button>
                </div>
            `).join('');
        }

        function breakdownGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (goal) {
                const { taskId, breakdown } = analyzeAndBreakdownTask(goal.text);
                showTaskBreakdown(taskId, breakdown, goal.text);
            }
        }

        // Render active goals in the main content
        function renderActiveGoals() {
            const container = document.getElementById('activeGoalsContainer');
            if (!container) return;
            
            const activeGoals = goals.filter(goal => !goal.completed);
            
            if (activeGoals.length === 0) {
                container.innerHTML = `
                    <div class="no-goals-message">
                        <div class="icon">üéØ</div>
                        <h3>No Active Goals</h3>
                        <p>Type your ONE thing above to get started, or add individual tasks from breakdowns.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activeGoals.map(goal => `
                <div class="goal-card" data-goal-id="${goal.id}">
                    <div class="goal-header">
                        <div class="goal-text">${goal.text}</div>
                    </div>
                    <div class="goal-meta">
                        <span class="goal-priority ${goal.priority}">${goal.priority}</span>
                        ${goal.estimatedTime ? `<span class="goal-time">‚è±Ô∏è ${goal.estimatedTime}m</span>` : ''}
                        ${goal.points ? `<span class="goal-time">‚≠ê ${goal.points} pts</span>` : ''}
                    </div>
                    <div class="goal-actions">
                        <button class="goal-action-btn complete-goal-btn" onclick="completeGoal(${goal.id})">
                            ‚úÖ Complete
                        </button>
                        ${goal.isOneThing ? '' : `<button class="goal-action-btn breakdown-goal-btn" onclick="breakdownGoal(${goal.id})">
                            üîç Break Down
                        </button>`}
                    </div>
                </div>
            `).join('');
        }

        // Render completed tasks
        function renderCompletedTasks() {
            const container = document.getElementById('completedTasksContainer');
            if (!container) return;
            
            const completedGoals = goals.filter(goal => goal.completed);
            
            if (completedGoals.length === 0) {
                container.innerHTML = `
                    <div class="no-goals-message">
                        <div class="icon">‚úÖ</div>
                        <h3>No Completed Tasks Yet</h3>
                        <p>Complete your first task to see it here!</p>
                    </div>
                `;
                return;
            }
            
            // Group by completion date
            const groupedTasks = {};
            completedGoals.forEach(goal => {
                const date = goal.completedAt ? new Date(goal.completedAt).toDateString() : 'Unknown';
                if (!groupedTasks[date]) {
                    groupedTasks[date] = [];
                }
                groupedTasks[date].push(goal);
            });
            
            // Sort dates (most recent first)
            const sortedDates = Object.keys(groupedTasks).sort((a, b) => {
                if (a === 'Unknown') return 1;
                if (b === 'Unknown') return -1;
                return new Date(b) - new Date(a);
            });
            
            container.innerHTML = sortedDates.map(date => `
                <div class="date-group">
                    <h4 class="date-header">${date === 'Unknown' ? 'Recently Completed' : date}</h4>
                    ${groupedTasks[date].map(goal => `
                        <div class="completed-task-card" data-goal-id="${goal.id}">
                            <div class="completed-task-header">
                                <div class="completed-task-text">${goal.text}</div>
                            </div>
                            <div class="completed-task-meta">
                                <span class="goal-priority ${goal.priority}">${goal.priority}</span>
                                ${goal.estimatedTime ? `<span class="completed-task-time">‚è±Ô∏è ${goal.estimatedTime}m</span>` : ''}
                                <span class="completed-task-time">‚≠ê ${goal.points} pts</span>
                                <span class="completed-task-date">${goal.completedAt ? new Date(goal.completedAt).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'}) : ''}</span>
                            </div>
                            <div class="completed-task-actions">
                                <button class="completed-task-action-btn restore-task-btn" onclick="restoreTask(${goal.id})">
                                    üîÑ Restore
                                </button>
                                <button class="completed-task-action-btn delete-task-btn" onclick="deleteCompletedTask(${goal.id})">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // Render task insights
        function renderTaskInsights() {
            const container = document.getElementById('insightsContainer');
            if (!container) return;
            
            const totalTasks = goals.length;
            const completedTasks = goals.filter(g => g.completed).length;
            const activeTasks = totalTasks - completedTasks;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // Calculate average points per task
            const totalPoints = goals.reduce((sum, goal) => sum + goal.points, 0);
            const avgPoints = totalTasks > 0 ? Math.round(totalPoints / totalTasks) : 0;
            
            // Priority distribution
            const priorityStats = {};
            goals.forEach(goal => {
                priorityStats[goal.priority] = (priorityStats[goal.priority] || 0) + 1;
            });
            
            container.innerHTML = `
                <div class="insight-card">
                    <div class="insight-header">
                        <div class="insight-icon">üìä</div>
                        <h3 class="insight-title">Task Overview</h3>
                    </div>
                    <div class="insight-stats">
                        <div class="insight-stat">
                            <div class="insight-stat-value">${totalTasks}</div>
                            <div class="insight-stat-label">Total Tasks</div>
                        </div>
                        <div class="insight-stat">
                            <div class="insight-stat-value">${completedTasks}</div>
                            <div class="insight-stat-label">Completed</div>
                        </div>
                        <div class="insight-stat">
                            <div class="insight-stat-value">${activeTasks}</div>
                            <div class="insight-stat-label">Active</div>
                        </div>
                        <div class="insight-stat">
                            <div class="insight-stat-value">${completionRate}%</div>
                            <div class="insight-stat-label">Success Rate</div>
                        </div>
                    </div>
                </div>
                
                <div class="insight-card">
                    <div class="insight-header">
                        <div class="insight-icon">üéØ</div>
                        <h3 class="insight-title">Priority Distribution</h3>
                    </div>
                    <div class="insight-content">
                        ${Object.entries(priorityStats).map(([priority, count]) => `
                            <div style="margin-bottom: 8px;">
                                <span class="goal-priority ${priority}">${priority}</span>
                                <span style="color: #9ca3af; margin-left: 8px;">${count} tasks</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="insight-card">
                    <div class="insight-header">
                        <div class="insight-icon">‚≠ê</div>
                        <h3 class="insight-title">Points & Rewards</h3>
                    </div>
                        <div class="insight-stats">
                            <div class="insight-stat">
                                <div class="insight-stat-value">${totalPoints}</div>
                                <div class="insight-stat-label">Total Points</div>
                            </div>
                            <div class="insight-stat">
                                <div class="insight-stat-value">${avgPoints}</div>
                                <div class="insight-stat-label">Avg per Task</div>
                            </div>
                        </div>
                </div>
            `;
        }

        // Update task counts in tabs
        function updateTaskCounts() {
            const activeCount = goals.filter(g => !g.completed).length;
            const completedCount = goals.filter(g => g.completed).length;
            
            document.getElementById('activeTaskCount').textContent = activeCount;
            document.getElementById('completedTaskCount').textContent = completedCount;
        }

        function toggleGoal(id) {
            const goal = goals.find(g => g.id === id);
            if (goal) {
                goal.completed = !goal.completed;
                
                if (goal.completed) {
                    goal.completedAt = new Date().toISOString(); // Add completion timestamp
                    addPoints(goal.points);
                    gameState.totalTasksCompleted++;
                    
                    // Update daily stats
                    const today = new Date().toDateString();
                    if (!statistics.dailyStats[today]) {
                        statistics.dailyStats[today] = { points: 0, tasks: 0, focusMinutes: 0, flowStates: 0 };
                    }
                    statistics.dailyStats[today].tasks++;
                    
                    updateAI(`Task completed! +${goal.points} points. ${getMotivationalMessage()}`);
                    updateAnalytics();
                    renderActivityLog();
                    saveOnEvent(); // Save after completing task
                } else {
                    delete goal.completedAt; // Remove completion timestamp if uncompleting
                }
                
                renderGoals();
                updateProgress();
                
                // Update tasks page if visible
                if (!document.getElementById('tasksPage').classList.contains('hidden')) {
                    updateTaskCounts();
                }
            }
        }

        // Complete goal from the active goals section
        function completeGoal(id) {
            const goal = goals.find(g => g.id === id);
            if (goal) {
                goal.completed = true;
                goal.completedAt = new Date().toISOString(); // Add completion timestamp
                addPoints(goal.points);
                gameState.totalTasksCompleted++;
                
                // Update daily stats
                const today = new Date().toDateString();
                if (!statistics.dailyStats[today]) {
                    statistics.dailyStats[today] = { points: 0, tasks: 0, focusMinutes: 0, flowStates: 0 };
                }
                statistics.dailyStats[today].tasks++;
                
                updateAI(`Task completed! +${goal.points} points. ${getMotivationalMessage()}`);
                renderGoals();
                updateProgress();
                updateAnalytics();
                renderActivityLog();
                saveOnEvent();
                
                // Update tasks page if visible
                if (!document.getElementById('tasksPage').classList.contains('hidden')) {
                    renderActiveGoals();
                    updateTaskCounts();
                }
            }
        }

        // Restore a completed task
        function restoreTask(id) {
            const goal = goals.find(g => g.id === id);
            if (goal && goal.completed) {
                goal.completed = false;
                delete goal.completedAt; // Remove completion timestamp
                
                updateAI(`Task restored: "${goal.text}" is now active again.`);
                renderGoals();
                updateProgress();
                saveOnEvent();
                
                // Update tasks page if visible
                if (!document.getElementById('tasksPage').classList.contains('hidden')) {
                    renderActiveGoals();
                    renderCompletedTasks();
                    updateTaskCounts();
                }
            }
        }

        // Delete a completed task permanently
        function deleteCompletedTask(id) {
            const goal = goals.find(g => g.id === id);
            if (goal && goal.completed) {
                if (confirm(`Are you sure you want to permanently delete "${goal.text}"? This cannot be undone.`)) {
                    // Remove from goals array
                    const goalIndex = goals.findIndex(g => g.id === id);
                    if (goalIndex > -1) {
                        goals.splice(goalIndex, 1);
                        
                        updateAI(`Task deleted: "${goal.text}" has been permanently removed.`);
                        renderGoals();
                        updateProgress();
                        saveOnEvent();
                        
                        // Update tasks page if visible
                        if (!document.getElementById('tasksPage').classList.contains('hidden')) {
                            renderActiveGoals();
                            renderCompletedTasks();
                            updateTaskCounts();
                        }
                    }
                }
            }
        }

        function getMotivationalMessage() {
            const messages = [
                "Excellent progress! Each task builds momentum.",
                "You're on fire! Keep this rhythm going.",
                "Great work! Your consistency is paying off.",
                "Outstanding! You're building powerful habits.",
                "Perfect execution! This compounds into success."
            ];
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function addPoints(points) {
            gameState.points += points;
            gameState.levelXP += points;
            
            // Update statistics
            statistics.allTimeStats.totalPoints = gameState.points;
            const today = new Date().toDateString();
            if (!statistics.dailyStats[today]) {
                statistics.dailyStats[today] = { points: 0, tasks: 0, focusMinutes: 0, flowStates: 0 };
            }
            statistics.dailyStats[today].points += points;
            
            if (gameState.levelXP >= gameState.levelXPRequired) {
                levelUp();
            }
            
            updateDisplay();
            updateAnalytics();
            showPointsAnimation(points);
            saveOnEvent(); // Save after adding points
        }

        function showPointsAnimation(points) {
            const elem = document.createElement('div');
            elem.className = 'points-animation';
            elem.textContent = `+${points}`;
            elem.style.left = '50%';
            elem.style.top = '50%';
            document.body.appendChild(elem);
            
            setTimeout(() => elem.remove(), 2000);
        }

        function levelUp() {
            gameState.level++;
            gameState.levelXP = gameState.levelXP - gameState.levelXPRequired;
            gameState.levelXPRequired = Math.floor(gameState.levelXPRequired * 1.2);
            
            showLevelUpModal();
            playLevelUpSound();
        }

        function showLevelUpModal() {
            const modal = document.createElement('div');
            modal.className = 'level-up-modal';
            modal.innerHTML = `
                <div class="level-up-title">LEVEL UP!</div>
                <div class="level-up-message">You've reached Level ${gameState.level}</div>
                <div class="level-up-reward">üéâ</div>
                <button class="timer-btn" onclick="this.parentElement.remove()">Awesome!</button>
            `;
            document.body.appendChild(modal);
            
            setTimeout(() => modal.remove(), 5000);
        }

        function playLevelUpSound() {
            if (!gameState.soundEnabled) return;
            
            const notes = [261.63, 329.63, 392.00, 523.25];
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioContext.currentTime + 0.3);
                }, i * 100);
            });
        }

        function updateProgress() {
            const total = goals.length;
            const completed = goals.filter(g => g.completed).length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('dailyProgress').textContent = `${percentage}%`;
            document.getElementById('dailyProgressBar').style.width = `${percentage}%`;
            
            // Update completion metric
            gameState.aiMetrics.completionRate = percentage;
            document.getElementById('completion').textContent = `${percentage}%`;
        }

        function updateDisplay() {
            document.getElementById('pointsDisplay').textContent = `${gameState.points.toLocaleString()} pts`;
            document.getElementById('levelDisplay').textContent = `Level ${gameState.level}`;
            document.getElementById('streakCount').textContent = `${gameState.streak} day streak`;
            document.getElementById('levelProgress').textContent = `${gameState.levelXP}/${gameState.levelXPRequired} XP`;
            document.getElementById('levelProgressBar').style.width = `${(gameState.levelXP / gameState.levelXPRequired) * 100}%`;
        }

        // AI Functions
        function updateAI(message) {
            document.getElementById('aiMessage').textContent = message;
        }

        // Loading overlay helpers
        function showLoadingOverlay(text) {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = `
                <div class="loading-card">
                    <div class="spinner"></div>
                    <div>${text || 'Loading...'}</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }

        function predictNext() {
            const predictions = [
                "Email review and response batch (85% confidence)",
                "Strategic planning for Q2 (78% confidence)",
                "Team performance reviews (72% confidence)"
            ];
            
            updateAI(`Based on your patterns, I predict your next tasks:
                
${predictions.join('\n')}

Your Tuesday pattern suggests focusing on strategic work now will cascade into easier afternoon tasks.`);
        }

        function optimizeEnergy() {
            const hour = new Date().getHours();
            const energyLevel = hour < 12 ? 'High' : hour < 15 ? 'Medium' : 'Low';
            
            updateAI(`Energy Optimization Report:
                
Current Energy: ${energyLevel}
Peak Hours Today: 9:00-11:00, 14:00-15:00

Recommended Schedule:
1. Complete ONE thing now (${energyLevel} energy)
2. Batch emails at 2 PM (Low energy task)
3. Creative work at 3 PM (Second peak)

You're 23% more productive when tasks match energy levels.`);
        }

        function findFlowTriggers() {
            updateAI(`Your Flow State Triggers:
                
‚Ä¢ Clear, challenging goals (not too easy, not too hard)
‚Ä¢ Uninterrupted time blocks (minimum 25 minutes)
‚Ä¢ Morning hours (9-11 AM)
‚Ä¢ After physical exercise
‚Ä¢ Classical or focus music
‚Ä¢ Single-tasking with notifications off

Current flow probability: 73%
You achieve flow 3x more often in the morning.`);
        }

        function analyzeBlockers() {
            updateAI(`Productivity Blockers Detected:
                
‚Ä¢ Context Switching (High impact)
  ‚Üí Solution: Batch similar tasks together
  
‚Ä¢ Decision Fatigue (Medium impact)
  ‚Üí Solution: Plan tomorrow tonight
  
‚Ä¢ Energy Misalignment (Medium impact)
  ‚Üí Solution: Move complex tasks to morning

Removing these could increase output by 31%.`);
        }

        function suggestBreak() {
            const breakTypes = [
                "5-minute walk outside - restores 23% cognitive capacity",
                "Deep breathing (4-7-8 technique) - reduces stress by 15%",
                "Hydration and stretching - improves focus for next session"
            ];
            
            const suggestion = breakTypes[Math.floor(Math.random() * breakTypes.length)];
            
            updateAI(`Smart Break Recommendation:
                
Suggested: ${suggestion}

Resume work at ${new Date(Date.now() + 5 * 60000).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'})}.

Your productivity increases 18% after strategic breaks.`);
        }

        function weeklyReview() {
            updateAI(`Weekly Intelligence Report:
                
üìä Performance Metrics:
‚Ä¢ 42 tasks completed (‚Üë18% from last week)
‚Ä¢ Average focus: 47 minutes
‚Ä¢ Best day: Tuesdays
‚Ä¢ Flow states achieved: 5 times

üß† AI Insights:
‚Ä¢ Your productivity peaks between 9-11 AM
‚Ä¢ Compound effect momentum: +24% daily
‚Ä¢ You're in the top 13% of users

üéØ Next Week Prediction:
78% likely to exceed this week if you maintain morning focus blocks.`);
        }

        function activatePowerUp(type, element) {
            if (gameState.powerUps[type]) {
                updateAI("This power-up is already active!");
                return;
            }
            
            gameState.powerUps[type] = true;
            element.classList.add('active');
            
            const messages = {
                focus: "Focus Boost activated! 2x points for 30 minutes.",
                streak: "Streak Shield activated! Your streak is protected today.",
                time: "Time Freeze activated! Take time to plan without pressure.",
                wisdom: "Wisdom Mode activated! Enhanced AI insights enabled."
            };
            
            updateAI(messages[type]);
            
            // Deactivate after 30 minutes (except streak shield)
            if (type !== 'streak') {
                setTimeout(() => {
                    gameState.powerUps[type] = false;
                    element.classList.remove('active');
                }, 30 * 60 * 1000);
            }
        }

        function adoptPrediction(text) {
            document.getElementById('goalInput').value = text;
            updateAI(`Prediction adopted: "${text}". Press Enter to add it to your goals.`);
        }

        function showStreakDetails() {
            updateAI(`üî• ${gameState.streak}-Day Streak Analysis:
                
‚Ä¢ Compound momentum: +${gameState.streak * 2}% daily efficiency
‚Ä¢ Habit formation strength: ${Math.min(100, gameState.streak * 3)}%
‚Ä¢ Next milestone: ${30 - gameState.streak} days to "Unstoppable" achievement

Your consistency is in the top ${100 - Math.min(99, gameState.streak * 2)}% of all users.`);
        }

        function showLevelProgress() {
            const tasksToLevel = Math.ceil((gameState.levelXPRequired - gameState.levelXP) / 50);
            updateAI(`Level ${gameState.level} Progress:
                
‚Ä¢ Current XP: ${gameState.levelXP}/${gameState.levelXPRequired}
‚Ä¢ Tasks to next level: ~${tasksToLevel}
‚Ä¢ Level velocity: ${(gameState.levelXP / gameState.level / 100).toFixed(2)} levels/week

You're leveling 23% faster than average.`);
        }

        function showPointsBreakdown() {
            updateAI(`Points Intelligence:
                
‚Ä¢ Total: ${gameState.points.toLocaleString()}
‚Ä¢ Today: ~250 points
‚Ä¢ Average per task: ${Math.round(gameState.points / Math.max(1, goalIdCounter))}
‚Ä¢ Streak bonus: ${gameState.streak * 2}%

Point velocity increasing 15% week-over-week.`);
        }

        // Show notification function
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <strong>üéØ AI Assistant</strong>
                <p style="margin-top: 5px; font-size: 14px;">${message}</p>
                <button class="btn" onclick="this.parentElement.remove()">Got it</button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Enhanced AI Features
        let aiInsights = {
            mood: 'focused',
            energyLevel: 'high',
            productivityPattern: 'morning',
            focusTriggers: ['classical music', 'morning hours', 'clear goals'],
            commonBlockers: ['context switching', 'decision fatigue', 'perfectionism'],
            optimalWorkHours: { start: 9, end: 11 },
            breakPattern: 'every 90 minutes',
            weeklyGoals: [],
            learningPreferences: 'visual',
            stressIndicators: []
        };

        // AI Mood and Energy Tracking
        function updateAIMood() {
            const hour = new Date().getHours();
            const dayOfWeek = new Date().getDay();
            const completedTasks = goals.filter(g => g.completed).length;
            const focusSessions = gameState.totalFocusSessions;
            
            // Determine mood based on various factors
            if (completedTasks > 3 && focusSessions > 0) {
                aiInsights.mood = 'accomplished';
            } else if (hour < 12) {
                aiInsights.mood = 'energized';
            } else if (hour > 16) {
                aiInsights.mood = 'tired';
            } else {
                aiInsights.mood = 'focused';
            }
            
            // Update energy level
            if (hour >= 9 && hour <= 11) {
                aiInsights.energyLevel = 'peak';
            } else if (hour >= 14 && hour <= 16) {
                aiInsights.energyLevel = 'moderate';
            } else {
                aiInsights.energyLevel = 'low';
            }
            
            updateAIDisplay();
        }

        // Enhanced AI Message Generation
        function generateAIMessage() {
            const hour = new Date().getHours();
            const mood = aiInsights.mood;
            const energy = aiInsights.energyLevel;
            const streak = gameState.streak;
            const completedToday = goals.filter(g => g.completed).length;
            
            let message = '';
            
            // Time-based insights
            if (hour < 12) {
                message += `Good morning! Your cognitive performance peaks in the next 2 hours. `;
            } else if (hour < 17) {
                message += `Afternoon energy check: You're in your ${energy} energy phase. `;
            } else {
                message += `Evening reflection: Great work today! `;
            }
            
            // Mood-based messages
            if (mood === 'accomplished') {
                message += `You're in an accomplished state - perfect for strategic thinking.`;
            } else if (mood === 'energized') {
                message += `High energy detected - tackle your most challenging tasks now.`;
            } else if (mood === 'tired') {
                message += `Energy is lower - focus on lighter, routine tasks.`;
            } else {
                message += `You're in a focused state - maintain this momentum.`;
            }
            
            // Progress-based encouragement
            if (completedToday > 0) {
                message += ` You've completed ${completedToday} tasks today.`;
            }
            
            if (streak > 1) {
                message += ` Your ${streak}-day streak is building powerful habits.`;
            }
            
            return message;
        }

        // Enhanced AI Action Functions
        function enhancedPredictNext() {
            const completedTasks = goals.filter(g => g.completed).length;
            const focusSessions = gameState.totalFocusSessions;
            const hour = new Date().getHours();
            
            let predictions = [];
            let confidence = 0;
            
            if (hour < 12 && completedTasks < 2) {
                predictions.push({
                    task: "Strategic planning and complex work",
                    confidence: 85,
                    reason: "Morning cognitive peak + fresh energy"
                });
                confidence = 85;
            } else if (hour >= 14 && hour <= 16) {
                predictions.push({
                    task: "Team collaboration and meetings",
                    confidence: 78,
                    reason: "Afternoon energy supports social interaction"
                });
                confidence = 78;
            } else if (hour > 16) {
                predictions.push({
                    task: "Planning and reflection",
                    confidence: 72,
                    reason: "Evening is ideal for strategic thinking"
                });
                confidence = 72;
            }
            
            let report = `üéØ Smart Task Prediction\n\n`;
            report += `Next Optimal Task: ${predictions[0]?.task || 'Routine tasks'}\n`;
            report += `Confidence: ${confidence}%\n`;
            report += `Reason: ${predictions[0]?.reason || 'Based on current energy and time'}\n\n`;
            
            if (predictions.length > 0) {
                report += `üìä Prediction Analysis:\n`;
                predictions.forEach(pred => {
                    report += `‚Ä¢ ${pred.task} (${pred.confidence}% confidence)\n`;
                    report += `  ‚Üí ${pred.reason}\n\n`;
                });
            }
            
            updateAI(report);
        }

        function enhancedEnergyOptimization() {
            const hour = new Date().getHours();
            const energy = aiInsights.energyLevel;
            const completedTasks = goals.filter(g => g.completed).length;
            
            let optimization = `‚ö° Energy Optimization Strategy\n\n`;
            optimization += `Current Time: ${hour}:00\n`;
            optimization += `Energy Level: ${energy.charAt(0).toUpperCase() + energy.slice(1)}\n`;
            optimization += `Tasks Completed: ${completedTasks}\n\n`;
            
            if (energy === 'peak') {
                optimization += `üöÄ Peak Energy Phase (9-11 AM):\n`;
                optimization += `‚Ä¢ Complex problem-solving\n`;
                optimization += `‚Ä¢ Strategic thinking and planning\n`;
                optimization += `‚Ä¢ Creative problem-solving\n\n`;
            } else if (energy === 'moderate') {
                optimization += `‚öñÔ∏è Moderate Energy Phase (2-4 PM):\n`;
                optimization += `‚Ä¢ Batch routine tasks\n`;
                optimization += `‚Ä¢ Team collaboration\n`;
                optimization += `‚Ä¢ Process improvement\n\n`;
            } else {
                optimization += `üåô Lower Energy Phase:\n`;
                optimization += `‚Ä¢ Administrative tasks\n`;
                optimization += `‚Ä¢ Learning and reading\n`;
                optimization += `‚Ä¢ Planning for tomorrow\n\n`;
            }
            
            // Break recommendations
            optimization += `üí° Break Strategy:\n`;
            optimization += `‚Ä¢ Every 90 minutes: 15-minute break\n`;
            optimization += `‚Ä¢ Hydration: Drink water every hour\n`;
            optimization += `‚Ä¢ Movement: 5-minute stretch breaks\n`;
            optimization += `‚Ä¢ Nature: 10-minute outdoor walk`;
            
            updateAI(optimization);
        }

        function enhancedFlowTriggers() {
            const userFlowTriggers = aiInsights.focusTriggers;
            const currentHour = new Date().getHours();
            const flowProbability = calculateFlowProbability();
            
            let flowReport = `üåä Flow State Analysis\n\n`;
            flowReport += `Current Flow Probability: ${flowProbability}%\n`;
            flowReport += `Optimal Flow Window: ${aiInsights.optimalWorkHours.start}:00 - ${aiInsights.optimalWorkHours.end}:00\n\n`;
            
            flowReport += `üéØ Your Personal Flow Triggers:\n`;
            userFlowTriggers.forEach(trigger => {
                flowReport += `‚Ä¢ ${trigger.charAt(0).toUpperCase() + trigger.slice(1)}\n`;
            });
            
            flowReport += `\nüöÄ Flow Activation Steps:\n`;
            flowReport += `1. Clear your workspace (remove distractions)\n`;
            flowReport += `2. Set a specific, challenging goal\n`;
            flowReport += `3. Start with 25-minute focus session\n`;
            flowReport += `4. Turn off all notifications\n`;
            flowReport += `5. Use ambient focus music\n\n`;
            
            flowReport += `‚è∞ Current Flow Status:\n`;
            if (currentHour >= aiInsights.optimalWorkHours.start && currentHour <= aiInsights.optimalWorkHours.end) {
                flowReport += `‚úÖ You're in your optimal flow window!`;
            } else {
                flowReport += `‚è≥ Wait ${aiInsights.optimalWorkHours.start - currentHour} hours for peak flow time.`;
            }
            
            updateAI(flowReport);
        }

        function calculateFlowProbability() {
            const hour = new Date().getHours();
            const dayOfWeek = new Date().getDay();
            const completedTasks = goals.filter(g => g.completed).length;
            const focusSessions = gameState.totalFocusSessions;
            
            let probability = 50; // Base probability
            
            // Time factor
            if (hour >= 9 && hour <= 11) probability += 25;
            else if (hour >= 14 && hour <= 16) probability += 15;
            else if (hour < 9 || hour > 17) probability -= 20;
            
            // Day factor
            if (dayOfWeek >= 1 && dayOfWeek <= 4) probability += 10; // Weekdays
            else probability -= 10; // Weekend
            
            // Task factor
            if (completedTasks > 0) probability += 15;
            if (focusSessions > 0) probability += 10;
            
            return Math.min(100, Math.max(0, probability));
        }

        // Enhanced AI Insights
        function enhancedWeeklyReview() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            
            const weeklyStats = calculateWeeklyStats();
            const insights = generateWeeklyInsights(weeklyStats);
            const recommendations = generateWeeklyRecommendations(weeklyStats);
            
            let report = `üìä Weekly Intelligence Report\n\n`;
            report += `üìÖ Week of ${weekStart.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}\n\n`;
            
            report += `üìà Performance Metrics:\n`;
            report += `‚Ä¢ Tasks Completed: ${weeklyStats.totalTasks}\n`;
            report += `‚Ä¢ Focus Sessions: ${weeklyStats.focusSessions}\n`;
            report += `‚Ä¢ Total Focus Time: ${weeklyStats.totalFocusTime}m\n`;
            report += `‚Ä¢ Average Daily Progress: ${weeklyStats.avgDailyProgress}%\n`;
            report += `‚Ä¢ Flow States Achieved: ${weeklyStats.flowStates}\n\n`;
            
            report += `üß† AI Insights:\n${insights}\n\nüéØ Next Week Recommendations:\n${recommendations}`;
            
            updateAI(report);
        }

        function calculateWeeklyStats() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            
            let totalTasks = 0;
            let totalFocusTime = 0;
            let focusSessions = 0;
            let flowStates = 0;
            let dailyProgress = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const dateStr = date.toDateString();
                const dayStats = statistics.dailyStats[dateStr] || { tasks: 0, focusMinutes: 0, flowStates: 0 };
                
                totalTasks += dayStats.tasks || 0;
                totalFocusTime += dayStats.focusMinutes || 0;
                focusSessions += dayStats.focusMinutes > 0 ? 1 : 0;
                flowStates += dayStats.flowStates || 0;
                
                const dayGoals = goals.filter(g => g.completed && new Date(g.completedAt).toDateString() === dateStr);
                dailyProgress.push(dayGoals.length);
            }
            
            return {
                totalTasks,
                totalFocusTime,
                focusSessions,
                flowStates,
                avgDailyProgress: Math.round(dailyProgress.reduce((a, b) => a + b, 0) / 7)
            };
        }

        function generateWeeklyInsights(stats) {
            let insights = [];
            
            if (stats.totalTasks > 20) {
                insights.push("üî• Exceptional productivity! You're in the top 10% of users");
            } else if (stats.totalTasks > 10) {
                insights.push("üöÄ Strong week! Your consistency is building momentum");
            } else {
                insights.push("üí™ Good foundation - focus on building daily habits");
            }
            
            if (stats.flowStates > 3) {
                insights.push("üåä Flow mastery achieved! You're optimizing your peak performance");
            }
            
            if (stats.avgDailyProgress > 70) {
                insights.push("üìà Consistent daily progress - compound effect in action");
            }
            
            return insights.join('\n');
        }

        function generateWeeklyRecommendations(stats) {
            let recommendations = [];
            
            if (stats.totalTasks < 15) {
                recommendations.push("üéØ Increase task complexity - challenge yourself more");
            }
            
            if (stats.focusSessions < 5) {
                recommendations.push("‚è±Ô∏è Schedule more focus sessions - quality over quantity");
            }
            
            if (stats.flowStates < 2) {
                recommendations.push("üåä Optimize your environment for flow states");
            }
            
            recommendations.push("üìù Plan next week's priorities tonight");
            recommendations.push("üéâ Celebrate your wins - you're building lasting habits");
            
            return recommendations.join('\n');
        }

        // Add individual micro-task to goals
        function addMicroTaskToGoals(microTaskId, breakdownId, taskText, estimatedTime, priority) {
            const breakdown = taskBreakdowns[breakdownId];
            if (!breakdown) return;
            
            // Create the micro-task goal
            const microTaskGoal = {
                id: ++goalIdCounter,
                text: taskText,
                completed: false,
                priority: priority,
                points: estimatedTime * 2, // Points based on time
                isOneThing: false,
                estimatedTime: estimatedTime,
                parentBreakdown: breakdownId,
                microTaskId: microTaskId
            };
            
            // Add to goals list
            goals.push(microTaskGoal);
            
            // Update display
            renderGoals();
            updateProgress();
            
            // Show success message
            updateAI(`‚úÖ Added "${taskText}" to your goals! This ${estimatedTime}-minute task is now part of your daily plan.`);
            
            // Update the button to show it's been added
            const addBtn = document.querySelector(`[onclick*="addMicroTaskToGoals(${microTaskId}"]`);
            if (addBtn) {
                addBtn.textContent = '‚úì Added';
                addBtn.disabled = true;
                addBtn.classList.add('added');
            }
            
            // Update tasks page if visible
            if (!document.getElementById('tasksPage').classList.contains('hidden')) {
                renderActiveGoals();
            }
        }

        // Page Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show selected page
            document.getElementById(pageId + 'Page').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            document.getElementById(pageId + 'Nav').classList.add('active');
            
            // If showing tasks page, make sure goals are rendered
            if (pageId === 'tasks') {
                showTaskTab('active'); // Show active tasks by default
            }
        }

        // Task Tab Navigation
        function showTaskTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.task-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId + 'TabContent').classList.add('active');
            
            // Update tab buttons
            document.querySelectorAll('.task-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            // Render appropriate content
            if (tabId === 'active') {
                renderActiveGoals();
            } else if (tabId === 'completed') {
                renderCompletedTasks();
            } else if (tabId === 'insights') {
                renderTaskInsights();
            }
            
            // Update task counts
            updateTaskCounts();
        }

        // Update AI display with enhanced features
        function updateAIDisplay() {
            const aiMessage = generateAIMessage();
            document.getElementById('aiMessage').textContent = aiMessage;
            updateAIInsightsPanel();
        }

        // Initialize enhanced AI
        updateAIMood();
        updateAIDisplay();
        
        // Initialize
        updateTimerDisplay();
        updateDisplay();
        updateAnalytics();
        renderActivityLog();
        
        // Update best streak
        if (gameState.streak > (gameState.bestStreak || 1)) {
            gameState.bestStreak = gameState.streak;
        }

        // Analytics functions
        function updateAnalytics() {
            // Update daily focus time
            const dailyFocusMinutes = statistics.dailyStats[new Date().toDateString()]?.focusMinutes || 0;
            document.getElementById('dailyFocusTime').textContent = `${dailyFocusMinutes}m`;
            const focusTimePercentage = Math.min(100, (dailyFocusMinutes / 120) * 100); // 2 hours target
            document.getElementById('dailyFocusTimeBar').style.width = `${focusTimePercentage}%`;
            
            // Update weekly flow state
            const weeklyFlowStates = Object.values(statistics.dailyStats).filter(stat => stat.flowStates > 0).length;
            const weeklyFlowPercentage = Math.round((weeklyFlowStates / 7) * 100);
            document.getElementById('weeklyFlowState').textContent = `${weeklyFlowPercentage}%`;
            document.getElementById('weeklyFlowStateBar').style.width = `${weeklyFlowPercentage}%`;
            
            // Update achievements count
            const achievementsCount = Object.keys(gameState.achievements).length;
            document.getElementById('achievementsCount').textContent = achievementsCount;
            const achievementsPercentage = Math.min(100, (achievementsCount / 10) * 100); // 10 achievements target
            document.getElementById('achievementsBar').style.width = `${achievementsPercentage}%`;
        }

        function renderActivityLog() {
            const container = document.getElementById('activityLog');
            const activities = generateRecentActivities();
            
            container.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon ${activity.type}">${activity.icon}</div>
                    <div class="activity-text">${activity.text}</div>
                    <div class="activity-time">${activity.time}</div>
                </div>
            `).join('');
        }

        function generateRecentActivities() {
            const activities = [];
            const now = new Date();
            
            // Add focus session if completed today
            if (gameState.totalFocusSessions > 0) {
                activities.push({
                    type: 'focus',
                    icon: '‚è±Ô∏è',
                    text: 'Completed focus session',
                    time: 'Just now'
                });
            }
            
            // Add recent goals
            const recentGoals = goals.filter(g => g.completed).slice(0, 3);
            recentGoals.forEach(goal => {
                activities.push({
                    type: 'goal',
                    icon: '‚úÖ',
                    text: `Completed: ${goal.text.substring(0, 30)}${goal.text.length > 30 ? '...' : ''}`,
                    time: 'Today'
                });
            });
            
            // Add level up if recent
            if (gameState.level > 1) {
                activities.push({
                    type: 'level',
                    icon: 'üéâ',
                    text: `Reached Level ${gameState.level}`,
                    time: 'This week'
                });
            }
            
            // Add streak milestone
            if (gameState.streak >= 7) {
                activities.push({
                    type: 'goal',
                    icon: 'üî•',
                    text: `${gameState.streak}-day streak active`,
                    time: 'Ongoing'
                });
            }
            
            // Fill with default activities if needed
            const defaultActivities = [
                { type: 'focus', icon: 'üéØ', text: 'Set daily focus goal', time: '9:00 AM' },
                { type: 'goal', icon: 'üìù', text: 'Added new task', time: '8:30 AM' },
                { type: 'level', icon: '‚≠ê', text: 'Earned 150 points', time: 'Yesterday' },
                { type: 'focus', icon: 'üí°', text: 'Welcome to Focus!', time: 'Just now' },
                { type: 'goal', icon: 'üöÄ', text: 'Ready to build habits', time: 'Now' }
            ];
            
            while (activities.length < 5 && activities.length < defaultActivities.length) {
                const defaultActivity = defaultActivities[activities.length];
                if (defaultActivity) {
                    activities.push(defaultActivity);
                }
            }
            
            return activities.slice(0, 5);
        }
        
        // Reset function
        function resetProgress() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        
        // Save before page unload
        window.addEventListener('beforeunload', saveState);
        
        // Track page visibility to save when switching tabs
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                saveState();
            }
        });

        // Periodic AI updates
        setInterval(() => {
            const messages = [
                `Pattern detected: Your next hour has high productivity potential. Focus probability: 82%.`,
                `Energy optimization: Consider a 5-minute break in ${Math.floor(Math.random() * 20 + 10)} minutes.`,
                `Your consistency score improved by 3% today. This compounds into lasting change.`,
                `Insight: Tasks completed before noon have 25% higher quality scores.`,
                `Total progress saved: ${gameState.totalTasksCompleted} tasks, ${gameState.totalFocusSessions} focus sessions.`
            ];
            
            if (Math.random() > 0.8) {
                showNotification(messages[Math.floor(Math.random() * messages.length)]);
            }
        }, 60000);

        // Welcome message - check if first time or returning user
        setTimeout(() => {
            if (savedData) {
                const tasksToday = goals.filter(g => g.completed).length;
                showNotification(`Welcome back! You've completed ${tasksToday} tasks today. Your ${gameState.streak}-day streak continues!`);
            } else {
                showNotification("Welcome to Focus! Your progress will be saved automatically. Let's build your first streak!");
            }
        }, 2000);
        
        // Show current stats in console for debugging
        console.log('Focus App Loaded:', {
            points: gameState.points,
            level: gameState.level,
            streak: gameState.streak,
            totalTasks: gameState.totalTasksCompleted,
            savedGoals: goals.length
        });

        // Update AI insights panel
        function updateAIInsightsPanel() {
            const hour = new Date().getHours();
            const mood = aiInsights.mood;
            const energy = aiInsights.energyLevel;
            const completedTasks = goals.filter(g => g.completed).length;
            const focusSessions = gameState.totalFocusSessions;
            
            let insights = [];
            
            // Time-based insights
            if (hour < 12) {
                insights.push("üåÖ Morning energy peak - tackle your most important task now");
            } else if (hour < 15) {
                insights.push("‚òÄÔ∏è Afternoon momentum - batch routine tasks together");
            } else {
                insights.push("üåÜ Evening reflection - plan tomorrow's priorities");
            }
            
            // Mood-based insights
            if (mood === 'accomplished') {
                insights.push("üöÄ You're in the zone! Consider a strategic break");
            } else if (mood === 'energized') {
                insights.push("‚ö° High energy - perfect for complex work");
            } else if (mood === 'tired') {
                insights.push("üí§ Energy low - switch to lighter tasks");
            }
            
            // Task-based insights
            if (completedTasks === 0) {
                insights.push("üéØ Start with your ONE thing - build momentum");
            } else if (completedTasks >= 3) {
                insights.push("üî• Excellent progress! You're ahead of schedule");
            }
            
            // Focus session insights
            if (focusSessions === 0) {
                insights.push("‚è±Ô∏è Schedule your first focus session today");
            } else if (focusSessions >= 2) {
                insights.push("üåä Multiple flow states achieved - you're optimizing");
            }
            
            // Update the insights panel
            const insightsContainer = document.getElementById('aiInsightsContent');
            if (insightsContainer) {
                insightsContainer.innerHTML = insights.map(insight => 
                    `<div style="margin-bottom: 8px; padding: 4px; 0;">${insight}</div>`
                ).join('');
            }
        }

        // Enhanced AI Features

        // Helper function to add goals manually
        function addGoal(text) {
            const priority = determinePriority(text);
            const points = priority === 'high' ? 100 : priority === 'medium' ? 60 : 30;
            
            const goal = {
                id: ++goalIdCounter,
                text: text,
                completed: false,
                priority: priority,
                points: points,
                isOneThing: false
            };
            
            goals.push(goal);
            renderGoals();
            updateProgress();
        }

        function determinePriority(text) {
            const textLower = text.toLowerCase();
            if (textLower.includes('urgent') || textLower.includes('important') || textLower.includes('critical')) {
                return 'high';
            } else if (textLower.includes('maybe') || textLower.includes('later') || textLower.includes('sometime')) {
                insights.push("üåä Multiple flow states achieved - you're optimizing");
            }
            
            // Update the insights panel
            const insightsContainer = document.getElementById('aiInsightsContent');
            if (insightsContainer) {
                insightsContainer.innerHTML = insights.map(insight => 
                    `<div style="margin-bottom: 8px; padding: 4px; 0;">${insight}</div>`
                ).join('');
            }
        }

        // Enhanced AI Features

        // Helper function to add goals manually
        function addGoal(text) {
            const priority = determinePriority(text);
            const points = priority === 'high' ? 100 : priority === 'medium' ? 60 : 30;
            
            const goal = {
                id: ++goalIdCounter,
                text: text,
                completed: false,
                priority: priority,
                points: points,
                isOneThing: false
            };
            
            goals.push(goal);
            renderGoals();
            updateProgress();
        }

        function determinePriority(text) {
            const textLower = text.toLowerCase();
            if (textLower.includes('urgent') || textLower.includes('important') || textLower.includes('critical')) {
                return 'high';
            } else if (textLower.includes('maybe') || textLower.includes('later') || textLower.includes('sometime')) {
                return 'low';
            }
            return 'medium';
        }

        // Add breakdown option to existing goals
        function addBreakdownOptionToGoals() {
            const goalsList = document.getElementById('goalsList');
            if (goalsList && goals.length > 0) {
                // Add breakdown button to each goal
                const goalItems = goalsList.querySelectorAll('.goal-item');
                goalItems.forEach((item, index) => {
                    if (!item.querySelector('.breakdown-btn')) {
                        const breakdownBtn = document.createElement('button');
                        breakdownBtn.className = 'breakdown-btn';
                        breakdownBtn.innerHTML = 'üîç';
                        breakdownBtn.title = 'Break down this task';
                        breakdownBtn.onclick = () => {
                            const goal = goals[index];
                            const { taskId, breakdown } = analyzeAndBreakdownTask(goal.text);
                            showTaskBreakdown(taskId, breakdown, goal.text);
                        };
                        
                        item.appendChild(breakdownBtn);
                    }
                });
            }
        }

        function resetTimer() {
            timeLeft = 25 * 60;
            isRunning = false;
            document.getElementById('timerBtn').textContent = 'Start Focus';
            document.getElementById('timerBtn').classList.remove('pause');
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            updateTimerDisplay();
        }

        // Set as today's ONE thing
        function setAsOneThing(breakdownId, originalTask) {
            const breakdown = taskBreakdowns[breakdownId];
            if (!breakdown) return;
            
            // Create the ONE thing goal
            const oneThingGoal = {
                id: ++goalIdCounter,
                text: originalTask,
                completed: false,
                priority: 'high',
                points: 200,
                isOneThing: true,
                breakdownId: breakdownId,
                microTasks: breakdown.microTasks
            };
            
            // Add to goals list
            goals.unshift(oneThingGoal);
            
            // Close modal and update display
            document.querySelector('.task-breakdown-modal').remove();
            renderGoals();
            updateProgress();
            
            // Show success message
            updateAI(`üéØ Perfect! "${originalTask}" is now your ONE thing for today. The AI has broken it down into ${breakdown.microTasks.length} manageable micro-tasks to help you succeed.`);
            
            // Update the focus input to show the ONE thing
            const focusInput = document.getElementById('focusInput');
            focusInput.value = originalTask;
            focusInput.disabled = true;
            focusInput.style.opacity = '0.7';
            focusInput.style.cursor = 'default';
            
            // Add a visual indicator that this is set
            focusInput.style.borderBottomColor = 'rgba(74, 222, 128, 0.5)';
            
            // Show progress indicator
            showOneThingProgress(breakdownId);
        }

        // Show ONE thing progress
        function showOneThingProgress(breakdownId) {
            const breakdown = taskBreakdowns[breakdownId];
            if (!breakdown) return;
            
            // Create progress indicator below the focus input
            const progressContainer = document.createElement('div');
            progressContainer.className = 'one-thing-progress';
            progressContainer.innerHTML = `
                <div class="progress-header">
                    <span class="progress-label">ONE Thing Progress</span>
                    <span class="progress-value">0/${breakdown.microTasks.length} micro-tasks completed</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="micro-tasks-mini">
                    ${breakdown.microTasks.map(task => `
                        <div class="mini-task ${task.completed ? 'completed' : ''}" onclick="completeMicroTask(${task.id}, ${breakdownId})">
                            <span class="mini-task-text">${task.text}</span>
                            <span class="mini-task-time">${task.estimatedTime}m</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Insert after the focus input container
            const focusContainer = document.querySelector('.focus-input-container');
            focusContainer.parentNode.insertBefore(progressContainer, focusContainer.nextSibling);
        }

        // Update ONE thing progress display
        function updateOneThingProgress(breakdownId) {
            const breakdown = taskBreakdowns[breakdownId];
            if (!breakdown) return;
            
            const progressContainer = document.querySelector('.one-thing-progress');
            if (!progressContainer) return;
            
            // Update progress value
            const progressValue = progressContainer.querySelector('.progress-value');
            if (progressValue) {
                progressValue.textContent = `${breakdown.completed}/${breakdown.total} micro-tasks completed`;
            }
            
            // Update progress bar
            const progressBar = progressContainer.querySelector('.progress-fill');
            if (progressBar) {
                const percentage = (breakdown.completed / breakdown.total) * 100;
                progressBar.style.width = `${percentage}%`;
            }
            
            // Update mini tasks
            const miniTasks = progressContainer.querySelectorAll('.mini-task');
            miniTasks.forEach((miniTask, index) => {
                if (breakdown.microTasks[index] && breakdown.microTasks[index].completed) {
                    miniTask.classList.add('completed');
                }
            });
        }

        // Complete the ONE thing
        function completeOneThing(breakdownId) {
            const breakdown = taskBreakdowns[breakdownId];
            if (!breakdown) return;
            
            // Find the ONE thing goal
            const oneThingGoal = goals.find(g => g.breakdownId === breakdownId);
            if (oneThingGoal) {
                oneThingGoal.completed = true;
                addPoints(200); // Bonus points for completing ONE thing
                
                // Update AI message
                updateAI(`üéâ Congratulations! You've completed your ONE thing for today: "${oneThingGoal.text}". This is a major win that will create momentum for the rest of your day!`);
                
                // Show celebration
                showOneThingCompletion(oneThingGoal.text);
            }
        }

        // Show ONE thing completion celebration
        function showOneThingCompletion(taskText) {
            const notification = document.createElement('div');
            notification.className = 'one-thing-completion-notification';
            notification.innerHTML = `
                <div class="completion-content">
                    <div class="active-goals-section">
                        <div class="section-label">üéØ Active Goals</div>
                        <div class="goals-container" id="activeGoalsContainer">
                            <!-- Goals will be populated here -->
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 8 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 8000);
        }
    </script>
</body>
</html>